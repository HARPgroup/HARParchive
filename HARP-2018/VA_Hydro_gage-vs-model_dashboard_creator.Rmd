---
header-includes: \pagenumbering{gobble}
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r, include=FALSE}
# INPUTS
# USGS Gage number
siteNo <- "03527000"

site <- "http://deq2.bse.vt.edu/d.bet"    #Specify the site of interest, either d.bet OR d.dh

basepath='C:\\Users\\Daniel\\Documents\\HARP\\GitHub\\hydro-tools';

# SETUP

source(paste(basepath,'config.local.private',sep='/'));
# Linking river segment to gage
gage.to.segment <- read.csv(file.path(hydro_tools, "HARP-2018", "DEQ_Model_vs_USGS_Comparison", "data", "Gage_To_Segment.csv"), header = TRUE, sep = ',', stringsAsFactors = FALSE)
gage.to.segment <- subset(gage.to.segment, gage.to.segment$gage_number == as.numeric(siteNo))
RivSeg <- gage.to.segment$river_segment
TitleRivSeg <- RivSeg
```

---
title: "Appendix C.13: USGS Gage `r paste(siteNo, " vs. ", TitleRivSeg)`"
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{flushleft}}
  - \posttitle{\end{flushleft}}
output:
  pdf_document

---

```{r inputs, include=FALSE}

source(paste(hydro_tools,"VAHydro-2.0/rest_functions.R", sep = "/")); 
source(paste(hydro_tools,"VAHydro-1.0/fn_vahydro-1.0.R", sep = "/"));  
source(paste(hydro_tools,"LowFlow/fn_iha.R", sep = "/"));
source(paste(hydro_tools, "HARP-2018/fn_gage+seg_mapper.R", sep = "/"));
#retrieve rest token
source(paste(hydro_tools,"auth.private", sep = "/"));#load rest username and password, contained in auth.private file
token <- rest_token(site, token, rest_uname, rest_pw);
options(timeout=120); # set timeout to twice default level to avoid abort due to high traffic

# Loading written gage description
library(readr)
description <- read_file(paste0(file.path(hydro_tools, "HARP-2018", "DEQ_Model_vs_USGS_Comparison", "gage_descriptions", siteNo), ".txt"))

# Generating gage location maps
gis_img <- fn_gage_and_seg_mapper(RivSeg, site, hydro_tools, token)
```



```{r, include = FALSE}
# GETTING MODEL DATA FROM VA HYDRO
# Splitting the River Segment string into each segment name
RivSegStr <- strsplit(RivSeg, "\\+")
RivSegStr <- RivSegStr[[1]]
RivSeg <- RivSegStr[1]
hydrocode = paste("vahydrosw_wshed_",RivSeg,sep="");
ftype = 'vahydro'; # nhd_huc8, nhd_huc10, vahydro
inputs <- list (
  hydrocode = hydrocode,
  bundle = 'watershed',
  ftype = 'vahydro'
)
#property dataframe returned
feature = FALSE;
odata <- getFeature(inputs, token, site, feature);
hydroid <- odata[1,"hydroid"];
fname <- as.character(odata[1,]$name );
print(paste("Retrieved hydroid",hydroid,"for", fname,RivSeg, sep=' '));
# get the p5.3.2, scenario  model segment attached to this river feature
inputs <- list(
  varkey = "om_model_element",
  featureid = hydroid,
  entity_type = "dh_feature",
  propcode = "p532cal_062211"
)
model <- getProperty(inputs, site, model)
```



```{r, include = FALSE}
# GETTING MODEL METRICS FROM VA HYDRO

# 00: Overall Mean Flow
alfinfo <- list(
  varkey = "overall_mean",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met00_Model_MeanFlow <- alfprop$propvalue

# 01: January Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met01_Mod_JanLF <- alfprop$propvalue

# 02: February Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml2",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met02_Mod_FebLF <- alfprop$propvalue

# 03: March Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met03_Mod_MarLF <- alfprop$propvalue

# 04: April Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml4",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met04_Mod_AprLF <- alfprop$propvalue

# 05: May Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml5",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met05_Mod_MayLF <- alfprop$propvalue

# 06: June Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml6",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met06_Mod_JunLF <- alfprop$propvalue

# 07: July Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met07_Mod_JulLF <- alfprop$propvalue

# 08: August Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml8",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met08_Mod_AugLF <- alfprop$propvalue

# 09: September Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml9",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met09_Mod_SepLF <- alfprop$propvalue

# 10: October Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml10",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met10_Mod_OctLF <- alfprop$propvalue

# 11: November Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml11",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met11_Mod_NovLF <- alfprop$propvalue

# 12: December Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml12",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met12_Mod_DecLF <- alfprop$propvalue

# 13: January Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met13_Model_JanMF <- alfprop$propvalue

# 14: February Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm2",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met14_Model_FebMF <- alfprop$propvalue

# 15: March Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met15_Model_MarMF <- alfprop$propvalue

# 16: April Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm4",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met16_Model_AprMF <- alfprop$propvalue

# 17: May Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm5",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met17_Model_MayMF <- alfprop$propvalue

# 18: June Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm6",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met18_Model_JunMF <- alfprop$propvalue

# 19: July Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met19_Model_JulMF <- alfprop$propvalue

# 20: August Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm8",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met20_Model_AugMF <- alfprop$propvalue

# 21: September Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm9",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met21_Model_SepMF <- alfprop$propvalue

# 22: October Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm10",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met22_Model_OctMF <- alfprop$propvalue

# 23: November Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm11",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met23_Model_NovMF <- alfprop$propvalue

# 24: December Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm12",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met24_Model_DecMF <- alfprop$propvalue

# 25: 1 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met25_Mod_1DayMinMin <- alfprop$propvalue

# 26: 1 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met26_Mod_1DayMinMed <- alfprop$propvalue

# 27: 3 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met27_Mod_3DayMinMin <- alfprop$propvalue

# 28: 3 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met28_Mod_3DayMinMed <- alfprop$propvalue

# 29: 7 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met29_Mod_7DayMinMin <- alfprop$propvalue

# 30: 7 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met30_Mod_7DayMinMed <- alfprop$propvalue

# 31: 30 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min30",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met31_Mod_30DayMinMin <- alfprop$propvalue

# 32: 30 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl30",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met32_Mod_30DayMinMed <- alfprop$propvalue

# 33: 90 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min90",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met33_Mod_90DayMinMin <- alfprop$propvalue

# 34: 90 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl90",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met34_Mod_90DayMinMed <- alfprop$propvalue

# 35: 7Q10
alfinfo <- list(
  varkey = "7q10",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met35_Model_7Q10 <- alfprop$propvalue

# 37: Drought of Record Year
alfinfo <- list(
  varkey = "dor_year",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met37_Model_DoR <- alfprop$propvalue

# 38: 1% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met38_Model_1NonEx <- alfprop$propvalue

# 39: 5% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne5",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met39_Model_5NonEx <- alfprop$propvalue

# 40: 50% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne50",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met40_Model_50NonEx <- alfprop$propvalue

# 41: 95% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne95",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met41_Model_95NonEx <- alfprop$propvalue

# 42: 99% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne99",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met42_Model_99NonEx <- alfprop$propvalue

# 43: September 10%
alfinfo <- list(
  varkey = "monthly_non-exceedance",
  propcode = "mne9_10",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met43_Model_Sep10 <- alfprop$propvalue

# 44: Mean Baseflow
alfinfo <- list(
  varkey = "baseflow",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met44_Model_Base <- alfprop$propvalue

# 45: January High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met45_Mod_JanHF <- alfprop$propvalue

# 46: February High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh2",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met46_Mod_FebHF <- alfprop$propvalue

# 47: March High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met47_Mod_MarHF <- alfprop$propvalue

# 48: April High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh4",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met48_Mod_AprHF <- alfprop$propvalue

# 49: May High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh5",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met49_Mod_MayHF <- alfprop$propvalue

# 50: June High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh6",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met50_Mod_JunHF <- alfprop$propvalue

# 51: July High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met51_Mod_JulHF <- alfprop$propvalue

# 52: August High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh8",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met52_Mod_AugHF <- alfprop$propvalue

# 53: September High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh9",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met53_Mod_SepHF <- alfprop$propvalue

# 54: October High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh10",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met54_Mod_OctHF <- alfprop$propvalue

# 55: November High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh11",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met55_Mod_NovHF <- alfprop$propvalue

# 56: December High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh12",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met56_Mod_DecHF <- alfprop$propvalue

# 57: 1 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met57_Mod_1DayMaxMax <- alfprop$propvalue

# 58: 1 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh1",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met58_Mod_1DayMaxMed <- alfprop$propvalue

# 59: 3 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met59_Mod_3DayMaxMax <- alfprop$propvalue

# 60: 3 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh3",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met60_Mod_3DayMaxMed <- alfprop$propvalue

# 61: 7 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met61_Mod_7DayMaxMax <- alfprop$propvalue

# 62: 7 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh7",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met62_Mod_7DayMaxMed <- alfprop$propvalue

# 63: 30 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max30",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met63_Mod_30DayMaxMax <- alfprop$propvalue

# 64: 30 Day Maximum High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh30",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met64_Mod_30DayMaxMed <- alfprop$propvalue

# 65: 90 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max90",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met65_Mod_90DayMaxMax <- alfprop$propvalue

# 66: 90 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh90",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met66_Mod_90DayMaxMed <- alfprop$propvalue

# 67: Mean Flow in Year of Drought of Record
alfinfo <- list(
  varkey = "dor_mean",
  featureid = as.integer(as.character(model$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met67_model_lfmin <- alfprop$propvalue
```



```{r, include = FALSE}
# GETTING GAGE DATA FROM VA HYDRO
hydrocode = paste("usgs_",siteNo,sep="");
ftype = 'vahydro'; # nhd_huc8, nhd_huc10, vahydro
inputs <- list (
  hydrocode = hydrocode
)
#property dataframe returned
feature = FALSE;
odata <- getFeature(inputs, token, site, feature);
hydroid <- odata[1,"hydroid"];
fname <- as.character(odata[1,]$name );
print(paste("Retrieved hydroid",hydroid,"for", fname,RivSeg, sep=' '));
# get the p5.3.2, scenario  model segment attached to this river feature
inputs <- list(
  varkey = "om_model_element",
  featureid = hydroid,
  entity_type = "dh_feature",
  propcode = "p532cal_062211"
)
gage <- getProperty(inputs, site, model)
```



```{r, include = FALSE}
# GETTING GAGE METRICS FROM VA HYDRO

# 00: Overall Mean Flow
alfinfo <- list(
  varkey = "overall_mean",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met00_Gage_MeanFlow <- alfprop$propvalue

# 01: January Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met01_Gage_JanLF <- alfprop$propvalue

# 02: February Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml2",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met02_Gage_FebLF <- alfprop$propvalue

# 03: March Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met03_Gage_MarLF <- alfprop$propvalue

# 04: April Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml4",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met04_Gage_AprLF <- alfprop$propvalue

# 05: May Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml5",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met05_Gage_MayLF <- alfprop$propvalue

# 06: June Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml6",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met06_Gage_JunLF <- alfprop$propvalue

# 07: July Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met07_Gage_JulLF <- alfprop$propvalue

# 08: August Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml8",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met08_Gage_AugLF <- alfprop$propvalue

# 09: September Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml9",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met09_Gage_SepLF <- alfprop$propvalue

# 10: October Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml10",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met10_Gage_OctLF <- alfprop$propvalue

# 11: November Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml11",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met11_Gage_NovLF <- alfprop$propvalue

# 12: December Low Flow
alfinfo <- list(
  varkey = "monthly_low_flow",
  propcode = "ml12",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met12_Gage_DecLF <- alfprop$propvalue

# 13: January Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met13_Gage_JanMF <- alfprop$propvalue

# 14: February Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm2",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met14_Gage_FebMF <- alfprop$propvalue

# 15: March Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met15_Gage_MarMF <- alfprop$propvalue

# 16: April Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm4",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met16_Gage_AprMF <- alfprop$propvalue

# 17: May Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm5",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met17_Gage_MayMF <- alfprop$propvalue

# 18: June Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm6",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met18_Gage_JunMF <- alfprop$propvalue

# 19: July Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met19_Gage_JulMF <- alfprop$propvalue

# 20: August Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm8",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met20_Gage_AugMF <- alfprop$propvalue

# 21: September Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm9",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met21_Gage_SepMF <- alfprop$propvalue

# 22: October Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm10",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met22_Gage_OctMF <- alfprop$propvalue

# 23: November Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm11",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met23_Gage_NovMF <- alfprop$propvalue

# 24: December Mean Flow
alfinfo <- list(
  varkey = "monthly_mean_flow",
  propcode = "mm12",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met24_Gage_DecMF <- alfprop$propvalue

# 25: 1 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met25_Gage_1DayMinMin <- alfprop$propvalue

# 26: 1 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met26_Gage_1DayMinMed <- alfprop$propvalue

# 27: 3 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met27_Gage_3DayMinMin <- alfprop$propvalue

# 28: 3 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met28_Gage_3DayMinMed <- alfprop$propvalue

# 29: 7 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met29_Gage_7DayMinMin <- alfprop$propvalue

# 30: 7 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met30_Gage_7DayMinMed <- alfprop$propvalue

# 31: 30 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min30",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met31_Gage_30DayMinMin <- alfprop$propvalue

# 32: 30 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl30",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met32_Gage_30DayMinMed <- alfprop$propvalue

# 33: 90 Day Minimum Low Flow
alfinfo <- list(
  varkey = "min_low_flow",
  propcode = "min90",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met33_Gage_90DayMinMin <- alfprop$propvalue

# 34: 90 Day Median Low Flow
alfinfo <- list(
  varkey = "med_low_flow",
  propcode = "medl90",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met34_Gage_90DayMinMed <- alfprop$propvalue

# 35: 7Q10
alfinfo <- list(
  varkey = "7q10",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met35_Gage_7Q10 <- alfprop$propvalue

# 37: Drought of Record Year
alfinfo <- list(
  varkey = "dor_year",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met37_Gage_DoR <- alfprop$propvalue

# 38: 1% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met38_Gage_1NonEx <- alfprop$propvalue

# 39: 5% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne5",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met39_Gage_5NonEx <- alfprop$propvalue

# 40: 50% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne50",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met40_Gage_50NonEx <- alfprop$propvalue

# 41: 95% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne95",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met41_Gage_95NonEx <- alfprop$propvalue

# 42: 99% Non-Exceedance
alfinfo <- list(
  varkey = "non-exceedance",
  propcode = "ne99",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met42_Gage_99NonEx <- alfprop$propvalue

# 43: September 10%
alfinfo <- list(
  varkey = "monthly_non-exceedance",
  propcode = "mne9_10",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met43_Gage_Sep10 <- alfprop$propvalue

# 44: Mean Baseflow
alfinfo <- list(
  varkey = "baseflow",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met44_Gage_Base <- alfprop$propvalue

# 45: January High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met45_Gage_JanHF <- alfprop$propvalue

# 46: February High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh2",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met46_Gage_FebHF <- alfprop$propvalue

# 47: March High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met47_Gage_MarHF <- alfprop$propvalue

# 48: April High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh4",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met48_Gage_AprHF <- alfprop$propvalue

# 49: May High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh5",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met49_Gage_MayHF <- alfprop$propvalue

# 50: June High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh6",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met50_Gage_JunHF <- alfprop$propvalue

# 51: July High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met51_Gage_JulHF <- alfprop$propvalue

# 52: August High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh8",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met52_Gage_AugHF <- alfprop$propvalue

# 53: September High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh9",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met53_Gage_SepHF <- alfprop$propvalue

# 54: October High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh10",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met54_Gage_OctHF <- alfprop$propvalue

# 55: November High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh11",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met55_Gage_NovHF <- alfprop$propvalue

# 56: December High Flow
alfinfo <- list(
  varkey = "monthly_high_flow",
  propcode = "mh12",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met56_Gage_DecHF <- alfprop$propvalue

# 57: 1 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met57_Gage_1DayMaxMax <- alfprop$propvalue

# 58: 1 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh1",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met58_Gage_1DayMaxMed <- alfprop$propvalue

# 59: 3 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met59_Gage_3DayMaxMax <- alfprop$propvalue

# 60: 3 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh3",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met60_Gage_3DayMaxMed <- alfprop$propvalue

# 61: 7 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met61_Gage_7DayMaxMax <- alfprop$propvalue

# 62: 7 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh7",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met62_Gage_7DayMaxMed <- alfprop$propvalue

# 63: 30 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max30",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met63_Gage_30DayMaxMax <- alfprop$propvalue

# 64: 30 Day Maximum High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh30",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met64_Gage_30DayMaxMed <- alfprop$propvalue

# 65: 90 Day Maximum High Flow
alfinfo <- list(
  varkey = "max_high_flow",
  propcode = "max90",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met65_Gage_90DayMaxMax <- alfprop$propvalue

# 66: 90 Day Median High Flow
alfinfo <- list(
  varkey = "med_high_flow",
  propcode = "medh90",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met66_Gage_90DayMaxMed <- alfprop$propvalue

# 67: Mean Flow in Year of Drought of Record
alfinfo <- list(
  varkey = "dor_mean",
  featureid = as.integer(as.character(gage$pid)),
  entity_type = "dh_properties"
)
alfprop <- getProperty(alfinfo, site, alfprop)
met67_USGS_lfmin <- alfprop$propvalue
```



```{r, include = FALSE}
# CALCULATING PERCENT ERRORS
# OVERALL MEAN FLOW
met00_PctError <- -(signif(((met00_Model_MeanFlow - met00_Gage_MeanFlow) / met00_Gage_MeanFlow)*100, digits=3));

# JANUARY LOW FLOW
met01_PctError <- -(signif(((met01_Mod_JanLF - met01_Gage_JanLF) / met01_Gage_JanLF)*100, digits=3));

# FEBRUARY LOW FLOW
met02_PctError <- -(signif(((met02_Mod_FebLF - met02_Gage_FebLF) / met02_Gage_FebLF)*100, digits=3));

# MARCH LOW FLOW
met03_PctError <- -(signif(((met03_Mod_MarLF - met03_Gage_MarLF) / met03_Gage_MarLF)*100, digits=3));

# APRIL LOW FLOW
met04_PctError <- -(signif(((met04_Mod_AprLF - met04_Gage_AprLF) / met04_Gage_AprLF)*100, digits=3));

# MAY LOW FLOW
met05_PctError <- -(signif(((met05_Mod_MayLF - met05_Gage_MayLF) / met05_Gage_MayLF)*100, digits=3));

# JUNE LOW FLOW
met06_PctError <- -(signif(((met06_Mod_JunLF - met06_Gage_JunLF) / met06_Gage_JunLF)*100, digits=3));

# JULY LOW FLOW
met07_PctError <- -(signif(((met07_Mod_JulLF - met07_Gage_JulLF) / met07_Gage_JulLF)*100, digits=3));

# AUGUST LOW FLOW
met08_PctError <- -(signif(((met08_Mod_AugLF - met08_Gage_AugLF) / met08_Gage_AugLF)*100, digits=3));

# SEPTEMBER LOW FLOW
met09_PctError <- -(signif(((met09_Mod_SepLF - met09_Gage_SepLF) / met09_Gage_SepLF)*100, digits=3));

# OCTOBER LOW FLOW
met10_PctError <- -(signif(((met10_Mod_OctLF - met10_Gage_OctLF) / met10_Gage_OctLF)*100, digits=3));

# NOVEMBER LOW FLOW
met11_PctError <- -(signif(((met11_Mod_NovLF - met11_Gage_NovLF) / met11_Gage_NovLF)*100, digits=3));

# DECEMBER LOW FLOW
met12_PctError <- -(signif(((met12_Mod_DecLF - met12_Gage_DecLF) / met12_Gage_DecLF)*100, digits=3));

# JANUARY MEAN FLOW
met13_PctError <- -(signif(((met13_Model_JanMF - met13_Gage_JanMF) / met13_Gage_JanMF)*100, digits=3));

# FEBRUARY MEAN FLOW
met14_PctError <- -(signif(((met14_Model_FebMF - met14_Gage_FebMF) / met14_Gage_FebMF)*100, digits=3));

# MARCH MEAN FLOW
met15_PctError <- -(signif(((met15_Model_MarMF - met15_Gage_MarMF) / met15_Gage_MarMF)*100, digits=3));

# APRIL MEAN FLOW
met16_PctError <- -(signif(((met16_Model_AprMF - met16_Gage_AprMF) / met16_Gage_AprMF)*100, digits=3));

# MAY MEAN FLOW
met17_PctError <- -(signif(((met17_Model_MayMF - met17_Gage_MayMF) / met17_Gage_MayMF)*100, digits=3));

# JUNE MEAN FLOW
met18_PctError <- -(signif(((met18_Model_JunMF - met18_Gage_JunMF) / met18_Gage_JunMF)*100, digits=3));

# JULY MEAN FLOW
met19_PctError <- -(signif(((met19_Model_JulMF - met19_Gage_JulMF) / met19_Gage_JulMF)*100, digits=3));

# AUGUST MEAN FLOW
met20_PctError <- -(signif(((met20_Model_AugMF - met20_Gage_AugMF) / met20_Gage_AugMF)*100, digits=3));

# SEPTEMBER MEAN FLOW
met21_PctError <- -(signif(((met21_Model_SepMF - met21_Gage_SepMF) / met21_Gage_SepMF)*100, digits=3));

# OCTOBER MEAN FLOW
met22_PctError <- -(signif(((met22_Model_OctMF - met22_Gage_OctMF) / met22_Gage_OctMF)*100, digits=3));

# NOVEMBER MEAN FLOW
met23_PctError <- -(signif(((met23_Model_NovMF - met23_Gage_NovMF) / met23_Gage_NovMF)*100, digits=3));

# DECEMBER MEAN FLOW
met24_PctError <- -(signif(((met24_Model_DecMF - met24_Gage_DecMF) / met24_Gage_DecMF)*100, digits=3));

# 1 DAY MIN
met25_PctError <- -(signif(((met25_Mod_1DayMinMin - met25_Gage_1DayMinMin) / met25_Gage_1DayMinMin)*100, digits=3));
met26_PctError <- -(signif(((met26_Mod_1DayMinMed - met26_Gage_1DayMinMed) / met26_Gage_1DayMinMed)*100, digits=3));

# 3 DAY MIN
met27_PctError <- -(signif(((met27_Mod_3DayMinMin - met27_Gage_3DayMinMin) / met27_Gage_3DayMinMin)*100, digits=3));
met28_PctError <- -(signif(((met28_Mod_3DayMinMed - met28_Gage_3DayMinMed) / met28_Gage_3DayMinMed)*100, digits=3));

# 7 DAY MIN
met29_PctError <- -(signif(((met29_Mod_7DayMinMin - met29_Gage_7DayMinMin) / met29_Gage_7DayMinMin)*100, digits=3));
met30_PctError <- -(signif(((met30_Mod_7DayMinMed - met30_Gage_7DayMinMed) / met30_Gage_7DayMinMed)*100, digits=3));

# 30 DAY MIN
met31_PctError <- -(signif(((met31_Mod_30DayMinMin - met31_Gage_30DayMinMin) / met31_Gage_30DayMinMin)*100, digits=3));
met32_PctError <- -(signif(((met32_Mod_30DayMinMed - met32_Gage_30DayMinMed) / met32_Gage_30DayMinMed)*100, digits=3));

# 90 DAY MIN
met33_PctError <- -(signif(((met33_Mod_90DayMinMin - met33_Gage_90DayMinMin) / met33_Gage_90DayMinMin)*100, digits=3));
met34_PctError <- -(signif(((met34_Mod_90DayMinMed - met34_Gage_90DayMinMed) / met34_Gage_90DayMinMed)*100, digits=3));

# 7Q10
met35_PctError <- -(signif(((met35_Model_7Q10 - met35_Gage_7Q10) / met35_Gage_7Q10)*100, digits=3));

# DROUGHT OF RECORD (MIN. 90 DAY MIN.) YEAR
if (met37_Gage_DoR == met37_Model_DoR) {
  met37_PctError <- 0;
} else {
  met37_PctError <- 100;
}

# 1% Non-exceedance Flow
met38_PctError <- -(signif(((met38_Model_1NonEx - met38_Gage_1NonEx) / met38_Gage_1NonEx)*100, digits=3));

# 5% Non-exceedance Flow
met39_PctError <- -(signif(((met39_Model_5NonEx - met39_Gage_5NonEx) / met39_Gage_5NonEx)*100, digits=3));

# 50% Non-exceedance Flow
met40_PctError <- -(signif(((met40_Model_50NonEx - met40_Gage_50NonEx) / met40_Gage_50NonEx)*100, digits=3));

# 95% Non-exceedance Flow
met41_PctError <- -(signif(((met41_Model_95NonEx - met41_Gage_95NonEx) / met41_Gage_95NonEx)*100, digits=3));

# 99% Non-exceedance Flow
met42_PctError <- -(signif(((met42_Model_99NonEx - met42_Gage_99NonEx) / met42_Gage_99NonEx)*100, digits=3));

# Sept. 10% Flow
met43_PctError <- -(signif(((met43_Model_Sep10 - met43_Gage_Sep10) / met43_Gage_Sep10)*100, digits=3));

# Baseflow (Average)
met44_PctError <- -(signif(((met44_Model_Base - met44_Gage_Base) / met44_Gage_Base)*100, digits=3));

# JANUARY HIGH FLOW
met45_PctError <- -(signif(((met45_Mod_JanHF - met45_Gage_JanHF) / met45_Gage_JanHF)*100, digits=3));

# FEBRUARY HIGH FLOW
met46_PctError <- -(signif(((met46_Mod_FebHF - met46_Gage_FebHF) / met46_Gage_FebHF)*100, digits=3));

# MARCH HIGH FLOW
met47_PctError <- -(signif(((met47_Mod_MarHF - met47_Gage_MarHF) / met47_Gage_MarHF)*100, digits=3));

# APRIL HIGH FLOW
met48_PctError <- -(signif(((met48_Mod_AprHF - met48_Gage_AprHF) / met48_Gage_AprHF)*100, digits=3));

# MAY HIGH FLOW
met49_PctError <- -(signif(((met49_Mod_MayHF - met49_Gage_MayHF) / met49_Gage_MayHF)*100, digits=3));

# JUNE HIGH FLOW
met50_PctError <- -(signif(((met50_Mod_JunHF - met50_Gage_JunHF) / met50_Gage_JunHF)*100, digits=3));

# JULY HIGH FLOW
met51_PctError <- -(signif(((met51_Mod_JulHF - met51_Gage_JulHF) / met51_Gage_JulHF)*100, digits=3));

# AUGUST HIGH FLOW
met52_PctError <- -(signif(((met52_Mod_AugHF - met52_Gage_AugHF) / met52_Gage_AugHF)*100, digits=3));

# SEPTEMBER HIGH FLOW
met53_PctError <- -(signif(((met53_Mod_SepHF - met53_Gage_SepHF) / met53_Gage_SepHF)*100, digits=3));

# OCTOBER HIGH FLOW
met54_PctError <- -(signif(((met54_Mod_OctHF - met54_Gage_OctHF) / met54_Gage_OctHF)*100, digits=3));

# NOVEMBER HIGH FLOW
met55_PctError <- -(signif(((met55_Mod_NovHF - met55_Gage_NovHF) / met55_Gage_NovHF)*100, digits=3));

# DECEMBER HIGH FLOW
met56_PctError <- -(signif(((met56_Mod_DecHF - met56_Gage_DecHF) / met56_Gage_DecHF)*100, digits=3));

# 1 DAY MAX
met57_PctError <- -(signif(((met57_Mod_1DayMaxMax - met57_Gage_1DayMaxMax) / met57_Gage_1DayMaxMax)*100, digits=3));
met58_PctError <- -(signif(((met58_Mod_1DayMaxMed - met58_Gage_1DayMaxMed) / met58_Gage_1DayMaxMed)*100, digits=3));

# 3 DAY MAX
met59_PctError <- -(signif(((met59_Mod_3DayMaxMax - met59_Gage_3DayMaxMax) / met59_Gage_3DayMaxMax)*100, digits=3));
met60_PctError <- -(signif(((met60_Mod_3DayMaxMed - met60_Gage_3DayMaxMed) / met60_Gage_3DayMaxMed)*100, digits=3));

# 7 DAY MAX
met61_PctError <- -(signif(((met61_Mod_7DayMaxMax - met61_Gage_7DayMaxMax) / met61_Gage_7DayMaxMax)*100, digits=3));
met62_PctError <- -(signif(((met62_Mod_7DayMaxMed - met62_Gage_7DayMaxMed) / met62_Gage_7DayMaxMed)*100, digits=3));

# 30 DAY MAX
met63_PctError <- -(signif(((met63_Mod_30DayMaxMax - met63_Gage_30DayMaxMax) / met63_Gage_30DayMaxMax)*100, digits=3));
met64_PctError <- -(signif(((met64_Mod_30DayMaxMed - met64_Gage_30DayMaxMed) / met64_Gage_30DayMaxMed)*100, digits=3));

# 90 DAY MAX
met65_PctError <- -(signif(((met65_Mod_90DayMaxMax - met65_Gage_90DayMaxMax) / met65_Gage_90DayMaxMax)*100, digits=3));
met66_PctError <- -(signif(((met66_Mod_90DayMaxMed - met66_Gage_90DayMaxMed) / met66_Gage_90DayMaxMed)*100, digits=3));

# LOW YEARLY MEAN
met67_PctError <- -(signif(((met67_model_lfmin - met67_USGS_lfmin) / met67_USGS_lfmin)*100, digits=3));
```



```{r, include = FALSE}
# DOWNLOADING AND PREPPING DATA
library(dataRetrieval)
library(lubridate)
library(plyr)
# 
# start.date <- "1984-01-01"
# end.date <- "2005-12-31"
# 
# # IMPORTING AND EXPORTING USGS DATA -----------------------------------------------------
# 
# pCode <- "00060"
# USGS_daily <- readNWISdv(siteNo, pCode, start.date, end.date)
# names(USGS_daily)
# USGS_daily <- renameNWISColumns(USGS_daily)
# 
# # Splitting the River Segment string into each segment name
# RivSegStr <- strsplit(RivSeg, "\\+")
# RivSegStr <- RivSegStr[[1]]
# num.segs <- length(RivSegStr)
# model_days <- length(seq(as.Date(start.date):as.Date(end.date)))
# 
# #Reads data into data frame "ovols", exports each seg's data
# if (num.segs == 1) {
#   # Downloading hourly model data
#   model_hourly <- read.csv(paste0("http://deq2.bse.vt.edu/p532c-sova/wdm/river/p532cal_062211/stream/", 
#                                   RivSeg, "_0111.csv"), header = FALSE, sep = ",", stringsAsFactors = FALSE);  
#   
#   # Converting hourly to daily data
#   model_hourly <- model_hourly[-1,]
#   model_hourly$V1 <- trimws(model_hourly$V1, which = "both")
#   colnames(model_hourly) <- c("year","month","day","hour","ovol")
#   model_hourly$date <- as.Date(paste0(model_hourly$year,"-",model_hourly$month,"-",model_hourly$day))
#   model_daily <- aggregate(model_hourly$ovol, list(model_hourly$date), FUN = sum)
#   colnames(model_daily) <- c("date","mod.flow")
#   
#   # Merging data
#   combined.flows <- merge(USGS_daily, model_daily, by.x = "Date", by.y = "date", all = TRUE)
#   
# } else {
#   ovols <- setNames(data.frame(replicate(num.segs,sample(0, model_days, rep = TRUE))), sprintf("flow%s", seq(from = 1, to = num.segs, by = 1)))
#   seg_ctr <- 1
#   for (seg_ctr in 1:length(RivSegStr)) {
#     # Downloading and exporting hourly model data
#     model_hourly <- read.csv(paste0("http://deq2.bse.vt.edu/p532c-sova/wdm/river/p532cal_062211/stream/", 
#                                     RivSegStr[seg_ctr], "_0111.csv"), header = FALSE, sep = ",", stringsAsFactors = FALSE);
#     
#     # Converting hourly to daily data and exporting daily data
#     model_hourly <- model_hourly[-1,]
#     model_hourly$V1 <- trimws(model_hourly$V1, which = "both")
#     colnames(model_hourly) <- c("year","month","day","hour","ovol")
#     model_hourly$date <- as.Date(paste0(model_hourly$year,"-",model_hourly$month,"-",model_hourly$day))
#     model_daily <- aggregate(model_hourly$ovol, list(model_hourly$date), FUN = sum)
#     colnames(model_daily) <- c("date","mod.flow")
#     
#     # Adding flow to a matrix, for later flow summing
#     ovols[,paste0("flow",seg_ctr)] <- model_daily$mod.flow
#   }
#   
#   # Sums ovols, outputs summed daily flows
#   model_daily$mod.flow <- rowSums(ovols)
#   
#   # Merging data and exporting merged data
#   combined.flows <- merge(USGS_daily, model_daily, by.x = "Date", by.y = "date", all = TRUE)
#   
#   seg_ctr <- seg_ctr + 1
# }

combined.flows <- read.csv(paste0(basepath, "\\HARP-2018\\DEQ_Model_vs_USGS_Comparison\\data\\original_(reproducible)_data\\derived_data\\trimmed+area-adjusted_data\\", siteNo, "_vs_", TitleRivSeg, " - Derived Data.csv"))
combined.flows$Date <- as.Date(combined.flows$date, format="%Y-%m-%d")

# REMOVING NA DATA --------------------------------------------------------

data <- combined.flows[complete.cases(combined.flows),]

# TRIMMING TO WATER YEAR --------------------------------------------------

data.length <- length(data$Date)
start.month <- month(data$Date[1])
end.month <- month(data$Date[data.length])
start.day <- day(data$Date[1])
end.day <- day(data$Date[data.length])

if (start.month <= 9) {
  start.year <- year(data$Date[1])
} else if (start.month == 10 & start.day == 1) {
  start.year <- year(data$Date[1])
} else {
  start.year <- year(data$Date[1]) + 1
}

if (end.month >= 10) {
  end.year <- year(data$Date[data.length])
} else if (end.month == 9 & end.day == 30) {
  end.year <- year(data$Date[data.length])
} else {
  end.year <- year(data$Date[data.length]) - 1
}

start.date <- paste0(start.year, "-10-01")
end.date <- paste0(end.year, "-09-30")

start.line <- which(data$Date == start.date)
end.line <- which(data$Date == end.date)

data <- data[start.line:end.line,]

# ELIMINATING UNNECCESARY COLUMNS -----------------------------------------

data <- data[,c("date", "gage.flow", "model.flow")]
data <- setNames(data, c("date", "gage.flow", "model.flow"))

```



```{r, include=FALSE}
# DOCUMENTATION -----------------------------------------------------------

# Creates plots zoomed in three-month periods of highest error, also calculates
# a few metrics pertaining to error -- such as percent of observations above 20%

library(zoo)
library(lubridate)
library(knitr)
library(ggplot2)

# INPUTS ----------------------------------------------------

# LOADING DATA ------------------------------------------------------------

# Calculating mean flow of gage and model
avg_gage <- mean(data$gage.flow)
avg_model <- mean(data$model.flow)

# ADDING ADDITIONAL DATA COLUMNS ------------------------------------------
data$year <- year(ymd(data$date))
data$month <- month(ymd(data$date))
data$day <- day(ymd(data$date))

data$date <- as.Date(data$date)
start.date <- data$date[1]
end.date <- data$date[length(data$date)]
DumYear <- data.frame(as.Date(seq(as.Date(start.date), as.Date(end.date), by = 'day')))
colnames(DumYear) <- 'date'
data <- merge.data.frame(data, DumYear, by="date", all=TRUE)



# initialize variables ----------------------------------------------------
# This section will create a hydrograph that will zoom in on 3 month segments where error is high
# It does so for the top three highest error periods

#all_data puts model gage flows and corresponding dates in one data frame
all_data <- data.frame(data$date, data$model.flow, data$gage.flow) 
all_data$counter <- 1:length(all_data$data.date) # counter fixes issues with row numbers later on in script
colnames(all_data) <- c('Date', 'Model Flow', 'Gage Flow', 'Counter')

# find the first date for which data is collected, (in date format)
# and a date that is roughly one year and two months past the first date
YearStart <- as.character(as.Date(all_data$Date[1]))     
fixer <- which(all_data$Date == paste0(year(YearStart)+1,"-11-30"))
YearEnd <- as.character(as.Date(all_data$Date[fixer]))

# YearStart_Row and YearEnd_Row are the rows corresponding the the YearStart and YearEnd dates
YearStart_Row <- as.numeric(which(all_data$Date==YearStart)) 
YearEnd_Row <- as.numeric(which(all_data$Date==YearEnd))

# initalize dataframes and counters, assign names for dataframe columns
#AvgMonthlyError: used within nested for loop to create a 1x12 matrix that holds 1 year of 3 month error segments
#Timespan_Error: used in large loop to store values from AvgMonthlyError; holds entire timespan of 3 month error segments
AvgMonthlyError <- data.frame(matrix(nrow=1,ncol=1));  
names(AvgMonthlyError)<-'Error' 
Timespan_Error <- data.frame(matrix(nrow=1, ncol=1)); 
names(Timespan_Error)<-'Error'
i <- 1; # used for first for loop to advance a year
x <- 1 # x and y used to advance dataframes
y <- 12

# start loops used for yearly and monthly data  -------------------------------------------------------------

loop <- as.numeric(round(length(data$date)/365, digits = 0))-1
for (i in 1:loop){                                # run loop for an entire data series
  year <- all_data[YearStart_Row:YearEnd_Row,] # specify year: 10-01-year1 to 11-30-year2
  m <- 1                                        # counter for nested loop
  
  MonthStart <- YearStart  # first date for 3 month timespan                      
  doi <- as.Date(MonthStart) 
  doi <- doi + seq(0,365,31) 
  # doi= date of interest. dummy variable just to create the function next.month
  next.month <- function(doi) as.Date(as.yearmon(doi) + 1/12) + as.numeric(as.Date(doi)-(as.Date(as.yearmon(doi))))
  
  #(re)initalize variables for the nested loop
  MonthEnd <-data.frame(next.month(doi));  # last date in 3 month timespan - used function to determine 3rd month
  MonthEnd <- MonthEnd[3,1]-2 # specifies end of month 3 as last date
  # (technically specifies 01 of month 4)
  
  # row numbers corresponding with start and end dates, as a number. See note below 
  MonthStart_Row <- as.numeric(which(as.Date(all_data$Date)==as.Date(MonthStart)))
  MonthEnd_Row <- as.numeric(which(as.Date(all_data$Date)==as.Date(MonthEnd)))
  
  # Note: Counter column is used here to specify which row starts MonthStart and MonthEnd_Row.
  # When rows are pulled from year row numbers are also pulled, 
  # so a counter must be used for proper row numbers.
  Start_new <- which(year$Counter==MonthStart_Row)
  End_new <- which(year$Counter==MonthEnd_Row)
  
  # begin nested loop
  for (m in 1:12){
    month_time <- year[Start_new:End_new ,]         #extract data for 3 month timespan within year of interest
    avgmonth_gage <- mean(month_time$`Gage Flow`)   # find average of gage flow for 3 months
    avgmonth_model <- mean(month_time$`Model Flow`) # find average of model flow for 3 months
    AvgMonthlyError[m,1] <- (avgmonth_gage - avgmonth_model)/ avgmonth_gage * 100  # percent error between gage and model
    
    MonthEnd<-as.Date(MonthEnd)
    MonthEnd<-MonthEnd+1
    MonthEndyear <- year(MonthEnd)   # Year associated with last month of extracted data 
    MonthEndmonth <- month(MonthEnd) # Month associated with last month of extracted data 
    
    # the next three lines are for the error calculations -- stop on 1st of month 4 (31 of month 3)
    # Note: this DOES include the 1st of the next month in error calculation
    # Put a control on what date the script advances by - if date is not 1st of month, reset it
    DateCheck <- as.Date(paste0(MonthEndyear,'-',MonthEndmonth,'-01'))
    if (MonthEnd != DateCheck)
      MonthEnd <- as.Date(paste0(MonthEndyear,'-', MonthEndmonth, '-01'))
    
    MonthEnd <- MonthEnd-1
    stopdate <- as.Date(MonthEnd)
    AvgMonthlyError[m,2] <- stopdate
    
    # Advance to next month or count
    MonthStart <- next.month(MonthStart)
    MonthEnd <- MonthEnd+1
    MonthEnd <- next.month(MonthEnd)
    MonthEnd <- MonthEnd-1
    StartMonth_Row <- which(as.Date(all_data$Date)==as.Date(MonthStart));     
    StartMonth_Row <- as.numeric(StartMonth_Row)
    EndMonth_Row <- which(as.Date(all_data$Date)==as.Date(MonthEnd));     
    EndMonth_Row <- as.numeric(EndMonth_Row)
    Start_new <- which(year$Counter==StartMonth_Row)
    End_new <- which(year$Counter==EndMonth_Row)
    m <- m + 1
  }
  
  Timespan_Error[x:y, 1] <- AvgMonthlyError[,1] # save the error entries from AvgMonthlyError
  Timespan_Error[x:y, 2] <- AvgMonthlyError[,2] # save the dates 
  
  # advance Timespan_Error for next run
  x <- x + 12  
  y <- y + 12
  
  YearStart <- as.Date(YearStart) + 365  # Advance 1 year
  YearEnd <- as.Date(YearEnd) + 365     # Advance 1 year & 2 months (from 10-01 to 11-30)
  
  # Put a control on what date the script advances by - if end date is not 11-30, reset it
  # - if begin date is not -10-01, reset it
  YearBeginyear <- year(YearStart)  # pull year of beginning year
  YearBeginCheck <- as.Date(paste0(YearBeginyear,'-10-01'))
  if (YearBeginyear != YearBeginCheck)     
    YearStart <- as.Date(paste0(YearBeginyear,'-10-01'))
  
  YearEndyear <- year(YearEnd)  # pull year of ending year
  YearEndCheck <- as.Date(paste0(YearEndyear,'-11-30'))
  if (YearEnd != YearEndCheck)     
    YearEnd <- as.Date(paste0(YearEndyear,'-11-30'))
  YearStart_Row <- which(as.Date(all_data$Date)== as.Date(YearStart))
  YearEnd_Row <- which(as.Date(all_data$Date) == as.Date(YearEnd))
  
  i <- i + 1
}

# This section of code will plot timeframes with high error.
# count the number of 3 month periods over 20% error, plot the highest 3 periods.

Timespan_Error$Logic <- Timespan_Error$Error>=20 | Timespan_Error$Error<= -20
HighError <- Timespan_Error[Timespan_Error$Logic=='TRUE',]
HighError<- HighError[order(abs(HighError$Error), decreasing = TRUE),]
names(HighError)<-c('Error', 'Date', 'Logic')

# pull data for each of these 3 month segments.
HighestErrors <- HighError[1:3,]
HighestErrors$Date <- as.Date(HighestErrors$Date)

# initalize variables for loop
erroryear <- data.frame(matrix(nrow=1,ncol=6))
errordates <- data.frame(matrix(nrow=1, ncol=2))
names(erroryear)<- c('endyear', 'endmonth', 'enddate', 'startyear', 'startmonth', 'startdate')
names(errordates)<- c('start date row', 'end date row')
storeplotdata1<- data.frame(matrix(nrow=1, ncol=4))
names(storeplotdata1)<- c('Date', 'ModelFlow', 'GageFlow', 'Counter')
storeplotdata2<- data.frame(matrix(nrow=1, ncol=4))
names(storeplotdata2)<- c('Date', 'ModelFlow', 'GageFlow', 'Counter')
storeplotdata3<- data.frame(matrix(nrow=1, ncol=4))
names(storeplotdata3)<- c('Date', 'ModelFlow', 'GageFlow', 'Counter')

q <- 1

for (q in 1:length(HighestErrors)){
  erroryear[q,1] <- year(HighestErrors$Date[q])  # ending year
  erroryear[q,2]<- month(HighestErrors$Date[q]) + 1 # ending month
  erroryear[q,4]<- year(HighestErrors$Date[q]) #startyear
  erroryear[q,5]<- month(HighestErrors$Date[q])-2 #startmonth
  
  if (erroryear[q,2] > 12) { # if end month is jan, must move year up
    erroryear[q,4] <- erroryear[q,1]
    erroryear[q,1]<- erroryear[q,1] + 1 # year for jan moves
    erroryear[q,2] <- 1
  }else if (erroryear[q,5] == -1) {
    erroryear[q,4] <- erroryear[q,4] - 1 # if january, go back a year and start november
    erroryear[q,5] <- 11
  }else if (erroryear[q,5] == 0) {
    erroryear[q,4] <- erroryear[q,4] - 1 # if january, go back a year and start november
    erroryear[q,5] <- 12
  } else{
    erroryear[q,1]<- erroryear[q,1]  #endyear
    erroryear[q,2]<- erroryear[q,2]  #endmonth
    erroryear[q,4]<- erroryear[q,4]  #startyear
    erroryear[q,5]<- erroryear[q,5]  #startmonth
  }
  erroryear[q,3]<- paste0(erroryear[q,1], '-',erroryear[q,2], '-01') #enddate
  erroryear$enddate <- as.Date(erroryear$enddate)
  erroryear[q,6]<- as.Date(paste0(erroryear[q,4], '-', erroryear[q,5], '-01')) #startdate
  erroryear$startdate <- as.Date(erroryear$startdate)
  
  errordates[q,1]<- as.character(erroryear$startdate[q])
  errordates[q,2]<- as.character(erroryear$enddate[q]-1)
  errordates[q,3]<- which(as.Date(all_data$Date)==as.Date(errordates$`start date row`[q]))
  errordates[q,4]<- which(as.Date(all_data$Date)==as.Date(errordates$`end date row`[q]))
  
  plot1<-all_data[errordates$V3[q]:errordates$V4[q],]
if (q==1){
  storeplotdata1<- plot1
}else if(q==2){
  storeplotdata2<- plot1
}else if(q==3){
  storeplotdata3<- plot1
}
  q <- q+1
}

# # create and export 3 plots: \plot for info of row q

error1 <- signif(HighestErrors$Error[1], digits=3)          #Create error variable to display on graph
error2 <- signif(HighestErrors$Error[2], digits=3)
error3 <- signif(HighestErrors$Error[3], digits=3)

# CREATES OUTPUT MATRIX -------------------------------------------------------
# also want to list the number of timespans that were over 20% error.
over20 <- signif(nrow(HighError)/nrow(Timespan_Error)*100, digits=3)
OUTPUT_MATRIX <- matrix(c(avg_gage, avg_model, over20), nrow=1, ncol=3)
rownames(OUTPUT_MATRIX) = c("Area Weighted Flow")
colnames(OUTPUT_MATRIX) = c('USGS', 'Model', 'Error>20 (%)')
overall_error <- signif((OUTPUT_MATRIX[1,1]-OUTPUT_MATRIX[1,2])/OUTPUT_MATRIX[1,1]*100, digits=3)
OUTPUT_MATRIX <- matrix(c(over20, met00_PctError), nrow=1, ncol=2)
rownames(OUTPUT_MATRIX) = c("Percent")
colnames(OUTPUT_MATRIX) = c('Error > 20%', 'Overall Error')

OUTPUT_MATRIX <- round(OUTPUT_MATRIX, digits = 2)
OUTPUT_MATRIXsaver <- OUTPUT_MATRIX
OUTPUT_MATRIX <- kable(format(OUTPUT_MATRIX, digits = 3))
# plot for highest error 
# Max/min for y axis scaling
max <- max(c(max(storeplotdata1$`Gage Flow`), max(storeplotdata1$`Model Flow`)));
min <- min(c(max(storeplotdata1$`Gage Flow`), max(storeplotdata1$`Model Flow`)));
xpos1 <- min(storeplotdata1$Date)+20
xpos2 <- max(storeplotdata1$Date)-20

# Creating and exporting plot
df <- data.frame(as.Date(storeplotdata1$Date), storeplotdata1$`Model Flow`, storeplotdata1$`Gage Flow`); 
colnames(df) <- c('Date', 'Model', 'USGS')
options(scipen=5, width = 1400, height = 950)
error1plot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGS, color=name_USGS), size=1) +
  geom_line(aes(y=Model, color=name_model), size=1)+
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  annotate("text", x=xpos1, y=max, label= paste0('Error:', '',error1, '', '%'), size=5)+
  annotate("text", x=xpos2, y=max, label= paste0('Date Range: ', '', 
             min(storeplotdata1$Date),': ', max(storeplotdata1$Date)), size=5)+
  labs(y = "Flow (cfs)")

# plot for second highest error 
# Max/min for y axis scaling
max <- max(c(max(storeplotdata2$`Gage Flow`), max(storeplotdata2$`Model Flow`)));
min <- min(c(max(storeplotdata2$`Gage Flow`), max(storeplotdata2$`Model Flow`)));
xpos1 <- min(storeplotdata2$Date)+20
xpos2 <- max(storeplotdata2$Date)-20

# Creating and exporting plot
df <- data.frame(as.Date(storeplotdata2$Date), storeplotdata2$`Model Flow`, storeplotdata2$`Gage Flow`); 
colnames(df) <- c('Date', 'Model', 'USGS')
options(scipen=5, width = 1400, height = 950)
error2plot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGS, color=name_USGS), size=1) +
  geom_line(aes(y=Model, color=name_model), size=1)+
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  annotate("text", x=xpos1, y=max, label= paste0('Error:', '',error2, '', '%'), size=5)+
  annotate("text", x=xpos2, y=max, label= paste0('Date Range: ', '', 
                                                 min(storeplotdata2$Date),': ', max(storeplotdata2$Date)), size=5)+
  labs(y = "Flow (cfs)")



# plot for third highest error 
# Max/min for y axis scaling
max <- max(c(max(storeplotdata3$`Gage Flow`), max(storeplotdata3$`Model Flow`)));
min <- min(c(max(storeplotdata3$`Gage Flow`), max(storeplotdata3$`Model Flow`)));
xpos1 <- min(storeplotdata3$Date)+20
xpos2 <- max(storeplotdata3$Date)-20

# Creating and exporting plot
df <- data.frame(as.Date(storeplotdata3$Date), storeplotdata3$`Model Flow`, storeplotdata3$`Gage Flow`); 
colnames(df) <- c('Date', 'Model', 'USGS')
options(scipen=5, width = 1400, height = 950)
error3plot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGS, color=name_USGS), size=1) +
  geom_line(aes(y=Model, color=name_model), size=1)+
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=14),
        axis.text=element_text(size=14, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  annotate("text", x=xpos1, y=max, label= paste0('Error:', '',error3, '', '%'), size=5)+
  annotate("text", x=xpos2, y=max, label= paste0('Date Range: ', '', 
                                                 min(storeplotdata3$Date),': ', max(storeplotdata3$Date)), size=5)+
  labs(y = "Flow (cfs)")

```
```{r setup, include=FALSE}

# LIBRARIES ---------------------------------------------------------------

library('IHA')
library('PearsonDS')
library('zoo')
library('lubridate')
library('lfstat')
library('ggplot2')
library('scales')
library('IHA')
library('knitr')

# ADDING ADDITIONAL DATA COLUMNS ------------------------------------------
data$year <- year(ymd(data$date))
data$month <- month(ymd(data$date))
data$day <- day(ymd(data$date))

# SETUP FOR CALCULATIONS --------------------------------------------------

# # Setup for ___ Day Min Calculations
# # Running gage calculations
# f3_USGS <- zoo(data$gage.flow, order.by = data$date)
# g2_USGS <- group2(f3_USGS, year = 'water')
# # Running model calculations
# f3_model <- zoo(data$model.flow, order.by = data$date)
# g2_model <- group2(f3_model, year = 'water')
# 
# # Setup for Monthly Means Calculations
# USGS_Monthly_Means <- aggregate(data$gage.flow, list(data$month), FUN = mean)
# Model_Monthly_Means <- aggregate(data$model.flow, list(data$month), FUN = mean)
# 
# # Setup for Montly Mins Calculations
# flows_USGS <- zoo(data$gage.flow, order.by = data$date)
# flows_model <- zoo(data$model.flow, order.by = data$date)

# Setup for Flow Exceedance Calculations
# Creating vectors of decreasing flow magnitude
data <- combined.flows[complete.cases(combined.flows),]
dec_flows_USGS <- sort(data$gage.flow, decreasing = TRUE)
dec_flows_model <- sort(data$model.flow, decreasing = TRUE)
# Determining the "rank" (0-1) of the flow value
num_observations <- as.numeric(length(data$date))
rank_vec <- as.numeric(c(1:num_observations))
# Calculating exceedance probability
prob_exceedance <- 100*((rank_vec) / (num_observations + 1))
# Creating vectors of calculated quantiles
model_prob_exceedance <- quantile(dec_flows_model, probs = c(0.01, 0.05, 0.5, 0.95, 0.99))
USGS_prob_exceedance <- quantile(dec_flows_USGS, probs = c(0.01, 0.05, 0.5, 0.95, 0.99))

# # Setup for Sept. 10% Flow
# sept_flows <- subset(data, month == '9')
# sept_quant_USGS <- quantile(sept_flows$gage.flow, 0.10)
# sept_quant_model <- quantile(sept_flows$model.flow, 0.10)

# Setup for Baseflow Calculations
data <- data[start.line:end.line,]
# ADDING ADDITIONAL DATA COLUMNS ------------------------------------------
data$year <- year(ymd(data$date))
data$month <- month(ymd(data$date))
data$day <- day(ymd(data$date))

data$date <- as.Date(data$date)
start.date <- data$date[1]
end.date <- data$date[length(data$date)]
DumYear <- data.frame(as.Date(seq(as.Date(start.date), as.Date(end.date), by = 'day')))
colnames(DumYear) <- 'date'
DumYear$date <- as.Date(DumYear$date)
data <- merge.data.frame(data, DumYear, by="date", all=TRUE)
data$date <- DumYear$date
data$year <- year(ymd(data$date))
data$month <- month(ymd(data$date))
data$day <- day(ymd(data$date))
gage.data <- data.frame(data$day, data$month, data$year, data$gage.flow)
names(gage.data) <- c('day', 'month', 'year', 'flow')
model.data <- data.frame(data$day, data$month, data$year, data$model.flow)
names(model.data) <- c('day', 'month', 'year', 'flow')
# Creating lowflow objects
USGSriver <- createlfobj(gage.data, hyearstart = 10, baseflow = TRUE, meta = NULL)
modelriver <- createlfobj(model.data, hyearstart = 10, baseflow = TRUE, meta = NULL)
baseflowriver<- data.frame(modelriver, USGSriver);
colnames(baseflowriver) <-c ('mday', 'mmonth', 'myear', 'mflow', 'mHyear', 'mBaseflow',
                             'gday', 'gmonth', 'gyear', 'gflow', 'gHyear', 'gBaseflow')
# removing NA values
baseflowriver<-baseflowriver[complete.cases(baseflowriver)==TRUE,]
USGSriver<- data.frame(baseflowriver$gday, baseflowriver$gmonth, baseflowriver$gyear, 
                       baseflowriver$gflow, baseflowriver$gHyear, baseflowriver$gBaseflow);
modelriver<- data.frame(baseflowriver$mday, baseflowriver$mmonth, baseflowriver$myear, 
                        baseflowriver$mflow, baseflowriver$mHyear, baseflowriver$mBaseflow)
names(USGSriver) <- c('day', 'month', 'year', 'flow', 'hyear', 'baseflow')
names(modelriver) <- c('day', 'month', 'year', 'flow', 'hyear', 'baseflow')
# Adding date vectors
USGSriver$date <- as.Date(paste0(USGSriver$year,"-",USGSriver$month,"-",USGSriver$day))
modelriver$date <- as.Date(paste0(modelriver$year,"-",modelriver$month,"-",modelriver$day))

# Setup for Low Flows
lf_model <- aggregate(modelriver$flow, by = list(modelriver$hyear), FUN = mean)
lf_USGS <- aggregate(USGSriver$flow, by = list(USGSriver$hyear), FUN = mean)
colnames(lf_model) <- c('Water Year', 'Mean Flow')
colnames(lf_USGS) <- c('Water Year', 'Mean Flow')

# Setup for Residuals
resid <- (data$model.flow - data$gage.flow)
resid <- data.frame(data$date, resid)




# OUTPUT TABLES -----
# Table 1: Monthly Average Flow
Table1 <- matrix(c(met00_Gage_MeanFlow, met13_Gage_JanMF, met14_Gage_FebMF,
                   met15_Gage_MarMF, met16_Gage_AprMF, met17_Gage_MayMF,
                   met18_Gage_JunMF, met19_Gage_JulMF, met20_Gage_AugMF,
                   met21_Gage_SepMF, met22_Gage_OctMF, met23_Gage_NovMF,
                   met24_Gage_DecMF, met00_Model_MeanFlow, met13_Model_JanMF,
                   met14_Model_FebMF, met15_Model_MarMF, met16_Model_AprMF,
                   met17_Model_MayMF, met18_Model_JunMF, met19_Model_JulMF,
                   met20_Model_AugMF, met21_Model_SepMF, met22_Model_OctMF,
                   met23_Model_NovMF, met24_Model_DecMF, met00_PctError,
                   met13_PctError, met14_PctError, met15_PctError,
                   met16_PctError, met17_PctError, met18_PctError,
                   met19_PctError, met20_PctError, met21_PctError,
                   met22_PctError, met23_PctError, met24_PctError),
                 nrow = 13, ncol = 3);
colnames(Table1) = c("USGS Gage", "Model", "Pct. Error");
rownames(Table1) = c("Overall Mean Flow", 
                     "Jan. Mean Flow", "Feb. Mean Flow",
                     "Mar. Mean Flow", "Apr. Mean Flow",
                     "May Mean Flow", "Jun. Mean Flow",
                     "Jul. Mean Flow", "Aug. Mean Flow",
                     "Sep. Mean Flow", "Oct. Mean Flow",
                     "Nov. Mean Flow", "Dec. Mean Flow");
Table1 <- round(Table1, digits = 2)
Table1 <- kable(format(Table1, digits = 3, drop0trailing = TRUE))
Table2 <- matrix(c(met01_Gage_JanLF, met02_Gage_FebLF, met03_Gage_MarLF,
                   met04_Gage_AprLF, met05_Gage_MayLF, met06_Gage_JunLF,
                   met07_Gage_JulLF, met08_Gage_AugLF, met09_Gage_SepLF,
                   met10_Gage_OctLF, met11_Gage_NovLF, met12_Gage_DecLF,
                   met01_Mod_JanLF, met02_Mod_FebLF, met03_Mod_MarLF, 
                   met04_Mod_AprLF, met05_Mod_MayLF, met06_Mod_JunLF,
                   met07_Mod_JulLF, met08_Mod_AugLF, met09_Mod_SepLF,
                   met10_Mod_OctLF, met11_Mod_NovLF, met12_Mod_DecLF,
                   met01_PctError, met02_PctError, met03_PctError,
                   met04_PctError, met05_PctError, met06_PctError,
                   met07_PctError, met08_PctError, met09_PctError,
                   met10_PctError, met11_PctError, met12_PctError),
                 nrow = 12, ncol = 3);
colnames(Table2) = c("USGS Gage", "Model", "Pct. Error");
rownames(Table2) = c("Jan. Low Flow", "Feb. Low Flow",
                     "Mar. Low Flow", "Apr. Low Flow",
                     "May Low Flow", "Jun. Low Flow",
                     "Jul. Low Flow", "Aug. Low Flow",
                     "Sep. Low Flow", "Oct. Low Flow",
                     "Nov. Low Flow", "Dec. Low Flow");
Table2 <- round(Table2, digits = 2)
Table2 <- kable(format(Table2, digits = 3, drop0trailing = TRUE))
# Table 3: Monthly High Flow
Table3 <- matrix(c(met45_Gage_JanHF, met46_Gage_FebHF, met47_Gage_MarHF,
                   met48_Gage_AprHF, met49_Gage_MayHF, met50_Gage_JunHF,
                   met51_Gage_JulHF, met52_Gage_AugHF, met53_Gage_SepHF,
                   met54_Gage_OctHF, met55_Gage_NovHF, met56_Gage_DecHF,
                   met45_Mod_JanHF, met46_Mod_FebHF, met47_Mod_MarHF,
                   met48_Mod_AprHF, met49_Mod_MayHF, met50_Mod_JunHF,
                   met51_Mod_JulHF, met52_Mod_AugHF, met53_Mod_SepHF,
                   met54_Mod_OctHF, met55_Mod_NovHF, met56_Mod_DecHF,
                   met45_PctError, met46_PctError, met47_PctError,
                   met48_PctError, met49_PctError, met50_PctError,
                   met51_PctError, met52_PctError, met53_PctError,
                   met54_PctError, met55_PctError, met56_PctError),
                 nrow = 12, ncol = 3);
colnames(Table3) = c("USGS Gage", "Model", "Pct. Error");
rownames(Table3) = c("Jan. High Flow", "Feb. High Flow",
                     "Mar. High Flow", "Apr. High Flow",
                     "May High Flow", "Jun. High Flow",
                     "Jul. High Flow", "Aug. High Flow",
                     "Sep. High Flow", "Oct. High Flow",
                     "Nov. High Flow", "Dec. High Flow");
Table3 <- round(Table3, digits = 2)
Table3 <- kable(format(Table3, digits = 3, drop0trailing = TRUE))
Table4 <- matrix(c(met25_Gage_1DayMinMin, met26_Gage_1DayMinMed,
                   met27_Gage_3DayMinMin, met28_Gage_3DayMinMed,
                   met29_Gage_7DayMinMin, met30_Gage_7DayMinMed,
                   met31_Gage_30DayMinMin, met32_Gage_30DayMinMed,
                   met33_Gage_90DayMinMin, met34_Gage_90DayMinMed,
                   met35_Gage_7Q10, met37_Gage_DoR,
                   met67_USGS_lfmin, met44_Gage_Base, 
                   met25_Mod_1DayMinMin, met26_Mod_1DayMinMed,
                   met27_Mod_3DayMinMin, met28_Mod_3DayMinMed,
                   met29_Mod_7DayMinMin, met30_Mod_7DayMinMed,
                   met31_Mod_30DayMinMin, met32_Mod_30DayMinMed,
                   met33_Mod_90DayMinMin, met34_Mod_90DayMinMed,
                   met35_Model_7Q10, met37_Model_DoR,
                   met67_model_lfmin, met44_Model_Base, 
                   met25_PctError, met26_PctError, met27_PctError,
                   met28_PctError, met29_PctError, met30_PctError,
                   met31_PctError, met32_PctError, met33_PctError,
                   met34_PctError, met35_PctError,
                   met37_PctError, met67_PctError, met44_PctError), 
                 nrow = 14, ncol = 3);
colnames(Table4) = c("USGS Gage", "Model", "Pct. Error");
rownames(Table4) = c("Min. 1 Day Min", "Med. 1 Day Min", 
                     "Min. 3 Day Min", "Med. 3 Day Min",
                     "Min. 7 Day Min", "Med. 7 Day Min",
                     "Min. 30 Day Min", "Med. 30 Day Min",
                     "Min. 90 Day Min", "Med. 90 Day Min", 
                     "7Q10", "Year of 90-Day Min. Flow",
                     "Drought Year Mean", "Mean Baseflow");
Table4 <- round(Table4, digits = 2)
Table4 <- kable(format(Table4, digits = 3, drop0trailing = TRUE))
# Table 5: Period High Flows
Table5 <- matrix(c(met57_Gage_1DayMaxMax, met58_Gage_1DayMaxMed,
                   met59_Gage_3DayMaxMax, met60_Gage_3DayMaxMed,
                   met61_Gage_7DayMaxMax, met62_Gage_7DayMaxMed,
                   met63_Gage_30DayMaxMax, met64_Gage_30DayMaxMed,
                   met65_Gage_90DayMaxMax, met66_Gage_90DayMaxMed,
                   met57_Mod_1DayMaxMax, met58_Mod_1DayMaxMed,
                   met59_Mod_3DayMaxMax, met60_Mod_3DayMaxMed,
                   met61_Mod_7DayMaxMax, met62_Mod_7DayMaxMed,
                   met63_Mod_30DayMaxMax, met64_Mod_30DayMaxMed,
                   met65_Mod_90DayMaxMax, met66_Mod_90DayMaxMed,
                   met57_PctError, met58_PctError,
                   met59_PctError, met60_PctError,
                   met61_PctError, met62_PctError,
                   met63_PctError, met64_PctError,
                   met65_PctError, met66_PctError), 
                 nrow = 10, ncol = 3);
colnames(Table5) = c("USGS Gage", "Model", "Pct. Error");
rownames(Table5) = c("Max. 1 Day Max", "Med. 1 Day Max", 
                     "Max. 3 Day Max", "Med. 3 Day Max",
                     "Max. 7 Day Max", "Med. 7 Day Max",
                     "Max. 30 Day Max", "Med. 30 Day Max",
                     "Max. 90 Day Max", "Med. 90 Day Max");
Table5 <- round(Table5, digits = 2)
Table5 <- kable(format(Table5, digits = 3, drop0trailing = TRUE))
# Table 6: Non-Exceedance Flows
Table6 <- matrix(c(met38_Gage_1NonEx, met39_Gage_5NonEx, met40_Gage_50NonEx,
                   met41_Gage_95NonEx, met42_Gage_99NonEx, met43_Gage_Sep10,
                   met38_Model_1NonEx, met39_Model_5NonEx, met40_Model_50NonEx,
                   met41_Model_95NonEx, met42_Model_99NonEx, met43_Model_Sep10,
                   met38_PctError, met39_PctError, met40_PctError,
                   met41_PctError, met42_PctError, met43_PctError), nrow = 6, ncol = 3);
colnames(Table6) = c("USGS Gage", "Model", "Pct. Error");
rownames(Table6) = c("1% Non-Exceedance", "5% Non-Exceedance",
                     "50% Non-Exceedance", "95% Non-Exceedance",
                     "99% Non-Exceedance", "Sept. 10% Non-Exceedance");
Table6 <- round(Table6, digits = 2)
Table6 <- kable(format(Table6, digits = 3, drop0trailing = TRUE))
# Creating names for plot legends
name_USGS <- paste('Gage', siteNo);
name_model <- paste('Model: River Seg.\n', RivSeg);

# CREATE FUNCTIONS FOR PLOTTING  ------------------------------------------
base_breaks <- function(n = 10){
  function(x) {
    axisTicks(log10(range(x, na.rm = TRUE)), log = TRUE, n = n)
  }
}
scaleFUN <- function(x) sprintf("%.0f", x)

```



```{r, echo=FALSE, warning=FALSE, message=FALSE}
gis_img
```

```{r, results = 'asis', echo=FALSE, warning=FALSE, message=FALSE}
description.cont <- paste0(" The average daily discharge error between the model and gage data for the 20 year timespan was ", OUTPUT_MATRIXsaver[1,2] ,"%, with ", OUTPUT_MATRIXsaver[1,1], "% of its rolling three month time spans above 20% error.")
cat(description)
cat(description.cont)
```

\pagebreak

## Table 1: Monthly Low Flows
```{r, echo=FALSE, warning=FALSE, message=FALSE}
Table2
```

## Table 2: Monthly Average Flows
```{r, echo=FALSE, warning=FALSE, message=FALSE}
Table1
```


\pagebreak

## Table 3: Monthly High Flows
```{r, echo=FALSE, warning=FALSE, message=FALSE}
Table3
```

## Table 4: Period Low Flows
```{r, echo=FALSE, warning=FALSE, message=FALSE}
Table4
```

## Table 5: Period High Flows
```{r, echo=FALSE, warning=FALSE, message=FALSE}
Table5
```

## Table 6: Non-Exceedance Flows
```{r, echo=FALSE, warning=FALSE, message=FALSE}
Table6
```

## Fig. 1: Hydrograph
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Basic hydrograph -----
# Max/min for y axis scaling
max <- max(c(max(data$gage.flow), max(data$model.flow)));
min <- min(c(min(data$gage.flow), max(data$model.flow)));
if (max > 10000){
  max <- 100000
}else if (max > 1000){
  max <- 10000
}else if (max > 100){
  max <- 1000
}else if (max > 10){
  max <- 100
}
if (min>100){
  min<-100
}else if (min>10){ 
  min<-10
}else 
  min<-1
if (min==100){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(100, 1000, 10000, 100000), 
                                    limits=c(min,max))
}else if (min==10){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else if (min==1){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(1, 10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else
  fixtheyscale<- scale_y_continuous(trans = log_trans(), breaks = base_breaks(), 
                                    labels=scaleFUN, limits=c(min,max))
df <- data.frame(as.Date(data$date), data$model.flow, data$gage.flow); 
colnames(df) <- c('Date', 'Model', 'USGS')
options(scipen=5, width = 1400, height = 950)
myplot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGS, color=name_USGS), size=0.5) +
  geom_line(aes(y=Model, color=name_model), size=0.5)+
  fixtheyscale+
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=12),
        axis.text=element_text(size=12, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(y = "Flow (cfs)")
myplot
```

# Fig. 2: Zoomed Hydrograph
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Zoomed hydrograph in year of lowest 90-year flow -----
# Running gage calculations
f3_USGS <- zoo(data$gage.flow, order.by = data$date)
g2_USGS <- group2(f3_USGS, year = 'water')
# Running model calculations
f3_model <- zoo(data$model.flow, order.by = data$date)
g2_model <- group2(f3_model, year = 'water')

yearly_Gage_90DayMin <- g2_USGS[,c(1,10)];
yearly_Mod_90DayMin <- g2_model[,c(1,10)];
low.year <- subset(yearly_Gage_90DayMin, yearly_Gage_90DayMin$`90 Day Min`==min(yearly_Gage_90DayMin$`90 Day Min`));
low.year <- low.year$year;
low.year <- subset(data, data$year==low.year);

# Scaling using max/min
max <- max(c(max(low.year$gage.flow), max(low.year$model.flow)));
min <- min(c(min(low.year$gage.flow), min(low.year$model.flow)));
if (max > 10000){
  max <- 100000
}else if (max > 1000){
  max <- 10000
}else if (max > 100){
  max <- 1000
}else if (max > 10){
  max <- 100
}
if (min>100){
  min<-100
}else if (min>10){ 
  min<-10
}else 
  min<-1
if (min==100){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(100, 1000, 10000, 100000), 
                                    limits=c(min,max))
}else if (min==10){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else if (min==1){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(1, 10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else
  fixtheyscale<- scale_y_continuous(trans = log_trans(), breaks = base_breaks(), 
                                    labels=scaleFUN, limits=c(min,max))
df <- data.frame(as.Date(low.year$date), low.year$model.flow, low.year$gage.flow); 
colnames(df) <- c('Date', 'Model', 'USGS')
options(scipen=5, width = 1400, height = 950)
myplot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGS, color=name_USGS), size=0.7) +
  geom_line(aes(y=Model, color=name_model), size=0.7)+
  fixtheyscale+ 
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=12),
        axis.text=element_text(size=12, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(y = "Flow (cfs)")
myplot
```

# Fig. 3: Flow Exceedance
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Flow exceedance plot -----
# Determining max flow value for exceedance plot scale
max <- max(c(max(dec_flows_model), max(dec_flows_USGS)));
min <- min(c(min(dec_flows_model), min(dec_flows_USGS)));

if (max > 10000){
  max <- 100000
}else if (max > 1000){
  max <- 10000
}else if (max > 100){
  max <- 1000
}else if (max > 10){
  max <- 100
}
if (min>100){
  min<-100
}else if (min>10){ 
  min<-10
}else 
  min<-1
if (min==100){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(100, 1000, 10000, 100000), 
                                    limits=c(min,max))
}else if (min==10){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else if (min==1){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(1, 10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else
  fixtheyscale<- scale_y_continuous(trans = log_trans(), breaks = base_breaks(), 
                                    labels=scaleFUN, limits=c(min,max))
df <- data.frame(prob_exceedance, dec_flows_model, dec_flows_USGS); 
colnames(df) <- c('Date', 'Model', 'USGS')
options(scipen=5, width = 1400, height = 950)
myplot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGS, color=name_USGS), size=0.8) +
  geom_line(aes(y=Model, color=name_model), size=0.8)+
  fixtheyscale+ 
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=12),
        axis.text=element_text(size=12, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(x= "Probability of Exceedance (%)", y = "Flow (cfs)")
myplot
```

# Fig. 4: Baseflow
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Baseflow Indiviudal Graph -----
# Determining max flow value for plot scale
max <- max(c(max(USGSriver$baseflow), max(modelriver$baseflow), max(USGSriver$flow), max(modelriver$flow)));
min <- min(c(min(USGSriver$baseflow), min(modelriver$baseflow), min(USGSriver$flow), min(modelriver$flow)));

if (max > 10000){
  max <- 100000
}else if (max > 1000){
  max <- 10000
}else if (max > 100){
  max <- 1000
}else if (max > 10){
  max <- 100
}
if (min>100){
  min<-100
}else if (min>10){ 
  min<-10
}else 
  min<-1
if (min==100){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(100, 1000, 10000, 100000), 
                                    limits=c(min,max))
}else if (min==10){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else if (min==1){
  fixtheyscale<- scale_y_continuous(trans = log_trans(), 
                                    breaks = c(1, 10, 100, 1000, 10000), 
                                    limits=c(min,max))
}else
  fixtheyscale<- scale_y_continuous(trans = log_trans(), breaks = base_breaks(), 
                                    labels=scaleFUN, limits=c(min,max))
df <- data.frame(as.Date(modelriver$date), modelriver$baseflow, USGSriver$baseflow, modelriver$flow, USGSriver$flow); 
colnames(df) <- c('Date', 'ModelBaseflow', 'USGSBaseflow', 'ModelFlow', 'USGSFlow')
options(scipen=5, width = 1400, height = 950)
myplot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGSBaseflow, color=name_USGS), size=0.5) +
  geom_line(aes(y=ModelBaseflow, color=name_model), size=0.5)+
  fixtheyscale+ 
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=12),
        axis.text=element_text(size=12, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(y = "Flow (cfs)")
myplot
```

# Fig. 5: Combined Baseflow
```{r, echo=FALSE, warning=FALSE, message=FALSE}
par(mfrow = c(1,1));
options(scipen=5, width = 1400, height = 950)
myplot <- ggplot(df, aes(x=Date)) + 
  geom_line(aes(y=USGSFlow, color=paste("Gage Flow")), size=1)+
  geom_line(aes(y=ModelFlow, color=paste("Model Flow")), size=0.5)+ 
  geom_line(aes(y=USGSBaseflow, color=paste("Gage Baseflow")), size=0.5) +
  geom_line(aes(y=ModelBaseflow, color=paste("Model Baseflow")), size=1)+
  fixtheyscale+ 
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=12),
        axis.text=element_text(size=12, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("black","red","grey", "light pink"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(y = "Flow (cfs)")
myplot
```



# Fig. 6: Largest Error Segment
```{r, echo=FALSE, warning=FALSE, message=FALSE}
error1plot
```

# Fig. 7: Second Largest Error Segment
```{r, echo=FALSE, warning=FALSE, message=FALSE}
error2plot
```

# Fig. 8: Third Largest Error Segment
```{r, echo=FALSE, warning=FALSE, message=FALSE}
error3plot
```

# Fig. 9: Residuals Plot
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Setup for Residuals
data <- combined.flows[complete.cases(combined.flows),]
resid <- (data$model.flow - data$gage.flow)
resid <- data.frame(data$date, resid)

# Residuals plot for hydrograph

zeroline <- rep_len(0, length(data$date)) 
quantresid <- data.frame(signif(quantile(resid$resid), digits=3))
min <- min(resid$resid)
max <- max(resid$resid)
names(quantresid) <- c('Percentiles')

df <- data.frame(as.Date(resid$data.date), resid$resid, zeroline); 
colnames(df) <- c('Date', 'Residual', 'Zeroline')
options(scipen=5, width = 1400, height = 950)
myplot <- ggplot(df, aes(x=Date)) + 
  geom_point(aes(y=Residual, color=name_USGS), size=1) +
  geom_line(aes(y=Zeroline, color=name_model), size=0.8)+
  scale_y_continuous(limits=c(min,max))+ 
  theme_bw()+ 
  theme(legend.position="top", 
        legend.title=element_blank(),
        legend.box = "horizontal", 
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.text=element_text(size=12),
        axis.text=element_text(size=12, colour="black"),
        axis.title=element_text(size=14, colour="black"),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.ticks = element_line(colour="black"),
        panel.grid.major=element_line(colour = "light grey"), 
        panel.grid.minor=element_blank())+
  scale_colour_manual(values=c("dark green","black"))+
  guides(colour = guide_legend(override.aes = list(size=5)))+
  labs(y = "Flow Difference(cfs)")
myplot
```