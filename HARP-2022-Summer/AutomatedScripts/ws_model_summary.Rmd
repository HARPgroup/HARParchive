---
date: "`r format(Sys.time(), '%m/%d/%Y')`"
author: ""
title: "`r params$doc_title`"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
    page_margins:
      bottom: 0.5
      top: 0.5
      right: 1
      left: 0.5
      header: 0.0
      footer: 0.0
params: 
  doc_title: "Comparison of Two VaHydro Models"
  rseg.file.path: [ "/media/model/p6/out/river/hsp2_2022/hydr/JA4_7280_7340_hydrd_wy.csv", "path/to/flow/data" ]
  rseg.hydrocode: [ "JA4_7280_7340","vahydrosw_wshed_JA4_7280_7340" ]
  rseg.ftype: [ "cbp60","vahydro" ]
  rseg.model.version: [ "cbp-6.0","vahydro-1.0" ]
  runid.list: [ "hsp2_2022","runid_11" ]
  rseg.metric.list: [ "Qout","l90_Qout","l30_Qout","l07_Qout","l01_Qout","consumptive_use_frac","wd_cumulative_mgd","ps_cumulative_mgd","wd_mgd","ps_mgd" ]
---

```{r setup, include=FALSE}
#https://cran.r-project.org/web/packages/officedown/officedown.pdf
#https://ardata-fr.github.io/officeverse/officedown-for-word.html#insert-sections
knitr::opts_chunk$set(echo = TRUE, fig.cap = TRUE)
library(officedown)
library(officer)
library(flextable)
library(hydrotools)
library(rjson)
basepath='/var/www/R'
source('/var/www/R/config.R')

site <- 'http://deq1.bse.vt.edu/d.dh'
json_obj_url <- paste(site, "node/62", sep ="/")

ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
# Load functions used during development
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/fn_get_prop.R")
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/rest_functions.R")
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/find_name.R")

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)

```

# Table of contents
```{r, echo = FALSE}
block_toc()
```

```{r UserInputs, include=FALSE}
rseg.filepath <- params$rseg.file.path
rseg.hydrocode <- params$rseg.hydrocode
rseg.ftype <- params$rseg.ftype
rseg.model.version <- params$rseg.model.version
runid.list <- params$runid.list
rseg.metric.list <- params$rseg.metric.list

rlist <- gsub('runid_', '', runid.list)

# r <- 1
for (r in 1:length(rseg.model.version)){
  
  # get rseg feature
  rseg.hydrocode.r <- rseg.hydrocode[r]
  rseg.ftype.r <- rseg.ftype[r]
  rseg_feature <- RomFeature$new(
    ds,
    list(hydrocode = rseg.hydrocode.r, ftype = rseg.ftype.r),
    TRUE
  )
  rseg.hydroid.r <- rseg_feature$hydroid
  
  # get rseg model
  rseg.model.version.r <- rseg.model.version[r]
  print(paste("searching", rseg.model.version.r,"model for river segment hydroid", rseg.hydroid.r))
  rseg.model.r <- RomProperty$new(
    ds,
    list(entity_type='dh_feature', featureid = rseg.hydroid.r, propcode=rseg.model.version.r),
    TRUE
  )
  
  if (exists("json_obj_url")) {
  rseg_obj_url.r <- paste(json_obj_url, rseg.model.r$pid, sep="/")
  rseg_model_info.r <- ds$auth_read(rseg_obj_url.r, "text/json", "")
  rseg_model_info.r <- fromJSON(rseg_model_info.r)
  } else {
  message("Error: json_obj_url is undefined.  Can not retrieve model and scenario information. (Hint: Use config.R to set json_obj_url) ")
  rseg_model_info.r <- list()
  }
  
  # stash the model run data to a variable
  # in case its needed outside the loop
  assign(paste0("dat",r), rseg_model_info.r) 
  
  # retrieve metrics for a run
  runid.r <- runid.list[r]
  rseg_table.r <- om_model_table(model_info = rseg_model_info.r,
                             runid.list = runid.r,
                             metric.list = rseg.metric.list,
                             include.elfgen = TRUE,
                             site = site,
                             site_base = omsite
                             )
  # retrieve flow data for a run
  # rseg.data.r <- data.table::fread(rseg.file.path[r])
  # sdate <- as.Date(min(rseg.data.1$date))         # set as 1 - since we want the same date range for all models(?)
  # edate <- as.Date(max(rseg.data.1$date))
  # 
  # rseg.cols.r <- names(rseg.data.r)
  # #rseg.flow.r <- zoo(as.numeric(as.character( rseg.data.r$Qout )), order.by = rseg.data.r$date)
  # #rseg.flow.r <- window(rseg.flow.r, start = sdate, end = edate)
  # rseg.data.r <- zoo(rseg.data.r, order.by = rseg.data.r$index)
  # rseg.data.r <- window(rseg.data.r, start = sdate, end = edate)
  # mode(rseg.data.r) <- 'numeric'
  
  # join results from multiple runs to a single dataframe
  if (r == 1){
    rseg_metrics.df <- rseg_table.r
  } else {
    rseg_metrics.df <- cbind(rseg_metrics.df,rseg_table.r)
  }
  
  # create an output for information on the models compared
  #output <- output_file[(length)]
  
  header1 <- fp_text(cs.family = "calibri", font.size = 16, bold = TRUE)
  normal.text <- fp_text(cs.family = "cambria", font.size = 12)
  
  fpar.model.r <- fpar(ftext(paste(rseg_model_info.r[[1]][[3]])), header1)
  fpar.hcode.r <- fpar(ftext(paste("Hydrocode:", rseg.hydrocode.r)), normal.text)
  fpar.ftype.r <- fpar(ftext(paste("Ftype:", rseg.ftype.r)), normal.text)
  fpar.version.r <- fpar(ftext(paste("Model Version:", rseg.model.version.r)), normal.text)
  fpar.id.r <- fpar(ftext(paste("Run ID:", runid.r)), normal.text)
  
}

```

```{r LoadStatsTable, include=FALSE}
rseg_table <- rseg_metrics.df
rseg_table <- cbind(rownames(rseg_table),rseg_table)
names(rseg_table)[names(rseg_table) == 'rownames(rseg_table)'] <- 'Desc'
rseg_table_raw <- rseg_table

rseg_table_sql <- paste('SELECT
                  CASE
                    WHEN "Desc" = "model" THEN "River Segment Model Statistics:"
                    WHEN "Desc" = "Qout" THEN "Mean Flow Out (cfs)"
                    WHEN "Desc" = "Qbaseline" THEN "Baseline Flow (cfs)"
                    WHEN "Desc" = "remaining_days_p0" THEN "Minimum Days of Storage Remaining"
                    WHEN "Desc" = "l01_Qout" THEN "1 Day Low Flow (cfs)"
                    WHEN "Desc" = "l07_Qout" THEN "7 Day Low Flow (cfs)"
                    WHEN "Desc" = "l30_Qout" THEN "30 Day Low Flow (cfs)"
                    WHEN "Desc" = "l90_Qout" THEN "90 Day Low Flow (cfs)"
                    WHEN "Desc" = "consumptive_use_frac" THEN "Consumptive Use Fraction (1.0-Qout/Qbaseline)"
                    WHEN "Desc" = "wd_cumulative_mgd" THEN "Cumulative Withdrawal Flow Out (mgd)"
                    WHEN "Desc" = "ps_cumulative_mgd" THEN "Cumulative Point Source Flow In (mgd)"
                    WHEN "Desc" = "wd_mgd" THEN "Withdrawal Flow Out (mgd)"
                    WHEN "Desc" = "ps_mgd" THEN "Point Source Flow In (mgd)"
                    ELSE Desc
                  END AS Description, *
                 FROM rseg_table_raw
                 WHERE Desc NOT IN ("riverseg","run_date","starttime","endtime","richness_change_abs","richness_change_pct","runid")
                 ',sep='')
rseg_table <- sqldf(rseg_table_sql)
rseg_table <- rseg_table[,-2]
#-------------------------------------------------------------------------------
statsdf <- rbind(rseg_table)
```


\newpage
# Flow Modeling

## Flow Duration Curve
```{r FDCRetrieve, echo = FALSE, message = FALSE, results = "asis"}
for (r in length(rseg.model.version)) {
  runid.r <- runid.list[r]
  rseg.runid.r <- rseg_model_info.r[[1]][[runid.r]]
  path.fdc.r <- rseg.runid.r[['fig.fdc']][['code']]
  
  if (r == 1){
    fig.fdc <- ggdraw() + 
    draw_image(path.fdc.r, width = 0.5)
  } else {
    fig.fdc <- fig.fdc + 
      draw_image(path.fdc.r, width = 0.5, x = 0.5)
  }

}
fig.fdc
```
## Mean Flow, Withdrawals and Point Sources
```{r AllFlowsRetrieve, echo = FALSE, message = FALSE, results = "asis"}
for (r in length(rseg.model.version)) {
  runid.r <- runid.list[r]
  rseg.runid.r <- rseg_model_info.r[[1]][[runid.r]]
  path.flows.all.r <- rseg.runid.r[['fig.flows.all']][['code']]
  
  if (r == 1){
    fig.flows.all <- ggdraw() + 
    draw_image(path.flows.all.r, width = 0.5)
  } else {
    fig.flows.all <- fig.flows.all + 
      draw_image(path.flows.all.r, width = 0.5, x = 0.5)
  }
}
fig.flows.all
```
## Dry Period Hydrograph
```{r DryRetrieve, echo = FALSE, message = FALSE, results = "asis"}
for (r in length(rseg.model.version)) {
  runid.r <- runid.list[r]
  rseg.runid.r <- rseg_model_info.r[[1]][[runid.r]]
  path.hydrograph.dry.r <- rseg.runid.r[['fig.hydrograph_dry']][['code']]

 if (r == 1){
    fig.hydrograph.dry <- ggdraw() + 
    draw_image(path.hydrograph.dry.r, width = 0.5)
  } else {
    fig.hydrograph.dry <- fig.flows.all + 
      draw_image(path.hydrograph.dry.r, width = 0.5, x = 0.5)
  }
}
fig.hydrograph.dry
```

## 90-day Low Flows over a 2 year Period
```{r L902YRetrieve, echo = FALSE, message = FALSE, results = "asis"}
for (r in length(rseg.model.version)) {
  runid.r <- runid.list[r]
  rseg.runid.r <- rseg_model_info.r[[1]][[runid.r]]
  path.l90.2yr.r <- rseg.runid.r[['fig.l90_flows.2yr']][['code']]
  
  if (r == 1){
      fig.l90.2yr <- ggdraw() + 
      draw_image(path.l90.2yr.r, width = 0.5)
    } else {
      fig.l90.2yr.dry <- fig.flows.all + 
        draw_image(path.l90.2yr.r, width = 0.5, x = 0.5)
    }
}
fig.l90.2yr.dry
```

## Ftable Visual
```{r ftable_crosssection, echo=TRUE}
#get ftable:
path_uci <- 'http://deq1.bse.vt.edu:81/p6/vadeq/input/param/river/vahydro_2022/ftables/'
ftable <- read.csv(paste(path_uci,  rseg.hydrocode[1], '.ftable', sep=''), 
                    sep='', 
                    header=FALSE,
                    nrows = 19, skip= 5)
if (ncol(ftable)==5) {
  ftable <- ftable[,1:4] #remove flow-thru col if it exists (for old models)
}
colnames(ftable) <- c('depth','area','vol','disch')

#pull channel length:
rseg<- RomFeature$new(ds,list(
    hydrocode= rseg.hydrocode[2], 
    ftype= rseg.ftype[2],
    bundle='watershed'), 
    TRUE)
model <- RomProperty$new(ds,list(
    varkey="om_water_model_node",
    featureid=rseg$hydroid,
    entity_type="dh_feature", 
    propcode=rseg.model.version[2]), 
  TRUE)
channel_prop <- RomProperty$new(ds,list(
    #varkey="om_USGSChannelGeomObject", #for local_channel it needs _sub added to end
    featureid=model$pid,
    entity_type='dh_properties',
    propname = '0. River Channel'),
  TRUE)
length <- RomProperty$new(channel_prop[["datasource"]],list(
    varkey="om_class_Constant",
    featureid=channel_prop$pid,
    entity_type='dh_properties',
    propname='length'),
  TRUE)
clength <- length$propvalue #channel length

#extract geometry:
h <- ftable$depth[10]

SWh <- ftable$area[10]*43560/clength
Ah <- ftable$vol[10]*43560/clength
b <- Ah/h*2 - SWh
slope <- (SWh-b)/(2*h)
bf <- b + 2*slope*h

#practicevalues from JL2_6850_6890:
#h <- 8.770787/100
#b <- 80.93515/100
#bf <- 136.3575/100
#z <- 3.159484/100
#cslope <- 0.002241783/100

# Generate data for the plot
trapezoid <- function(x, z){ #piecewise function utilizing R's understanding of TRUE==1 and FALSE==0
  (x <= -0.5*bf | x >= 0.5*bf) * h +
  (x >= -2.5*bf | x <= 2.5*bf) * h +
  (x <= -2.5*bf - 3/2*(bf-b) | x >= 2.5*bf + (3/2*(bf-b))) * 4*h
  #(x >= 2.5*bf) * (slope)
}

x <- seq(-4*bf, 4*bf,length.out=50)
y <- seq(0, 5*bf, length.out=50)
z <- outer(x, y, trapezoid)
 
# Create the plot
persp(x, y, z, theta = 0, phi = 20, expand = 1, col = "gray", axes=TRUE, nticks=10, ticktype="detailed", scale=FALSE)

# Visualizing a simple DEM model
 volcano
z <- 2 * volcano     # Exaggerate the relief
x <- 10 * (1:nrow(z)) # 10 meter spacing (S to N)
y <- 10 * (1:ncol(z)) # 10 meter spacing (E to W)
 
# Don't draw the grid lines : border = NA
par(bg = "gray")
persp(x, y, z, theta = 135, phi = 30,
      col = "brown", scale = FALSE,
    ltheta = -120, shade = 0.75,
      border = NA, box = FALSE)


#segments(x0, y0, x1, y1)
```

```{r crosssect, echo=TRUE}
plot.new()
polygon(c(0, 0, 1, 1), c(0, 1, 1, 0))
polygon(c(0, 0.15, 0.23, 0.08), c(0.5, 0.9, 0.8, 0.4)) #left fp
polygon(c(0.08, 0.23, 0.36, 0.21), c(0.4, 0.8, 0.79, 0.39)) #left fp
polygon(c(0.645, 0.795, 0.926, 0.776), c(0.38, 0.784, 0.795, 0.4)) #rt fp
polygon(c(0.776, 0.846, 0.996, 0.926), c(0.4, 0.5, 0.895, 0.795)) #rt fp

segments(0.21, 0.39, 0.33, 0.15) #left channel
polygon(c(0.22, 0.33, 0.55, 0.635), c(0.37, 0.15, 0.14, 0.36), col='blue')
segments(0.55, 0.15, 0.645, 0.38) #rt channel

polygon(c(0.22, 0.635, 0.785, 0.365), c(0.37, 0.36, 0.76, 0.77), col='blue')
```

\newpage

<!---BLOCK_LANDSCAPE_START--->
# Metrics Summary

```{r StatsTable, echo=FALSE}
ft <- qflextable(statsdf)

# Set column widths
ft <- width(ft, j = 2:length(statsdf[1,]), width = 1.9)
ft <- width(ft, j = 1, width = 2.5)

# Set theme
ft <- theme_box(ft)

# Set background color of select rows --------------------------------------------------------------
ft <- bg(ft, bg = "#EFEFEF", part = "header")
ft <- bg(ft, i = ~ Description == "River Segment Model Statistics:", bg = "#EFEFEF", part = "body")
fontsize(ft, size = 9)
```
<!---BLOCK_LANDSCAPE_STOP--->
