---
title: "An Analysis of USGS Gauge Mean Streamflow for Winter and Spring from 2000 to Present"
author: "Ella Fox, Glenn Campagna and Megan Pritchard"
date: "5/15/2023"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
geometry: left=2cm, right=3cm
params:
  doc_title: "USGS Gauge Mean Stremflow Winter/Spring"
  rseg.gauge: ["01636500","01668000","02037500","03529500", "03532000", "03524000", "03527220","02066000" ] #overidden by params in render cmnd
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Starting Info 

Scope: Develop RMD workflow to characterize USGS gauge mean streamflow for Winter (Dec-March) and Spring (April-present) from 2000 to present. Create visualization to highlight winters/springs that are above/below long-term winter mean and spring mean. dataretreival package.

Context: Previous research has shown that the amount of winter recharge, that is precipitation that infiltrates into groundwater, is an indicator of the subsequent summer streamflow. Thus, low winter recharge (indicated by streamflow between Dec-March) is a warning indicator for potential summer drought conditions. While Joey/DEQ have tools at the ready for drought prediction, the casual hydrologist may wonder things like seems like the hiking trails are dry this time year, is this just me or backed up with data? or I had to mow my grass before April the year...I wonder if the early leaf-on will result in sustained evapotranspiration that reduces water storage to the point of impacting summer streamflow?

## List of gauge numbers used and why 
We want locations in drought conditions. Locations downstream are better within larger rivers to represent large basins. The locations need to be above the fall line which is between the Coastal Plain and Piedmont regions of VA


## Retrieving data from the USGS
```{r, include=FALSE}
#calling packages needed

library(zoo)
#library(IHA)  #Package not available for this version of R
#install.packages("dataRetrieval")
library(dataRetrieval)
library(dplyr)
  #megan had dependency issues loading "dplyr" and had to do this:
  #library(devtools)
  #remove.packages("cli")
  #install.packages("cli")
  #install_version("vctrs", version = "0.5.0", repos = "http://cran.us.r-project.org")
library(ggplot2)
  #to load ggplot2, had to update dependency "rlang" by doing this:
  #remove.packages("rlang")
  #install.packages("rlang")
library(knitr)
library(tidyverse)
library(pals)
library(lubridate)
library(stats)

```

```{r}
#retrieve flow data for desired river basin gauge

siteNumber <- '01636500' #We want to make this a customization variable, rn using shenandoah into Potomac to test 

startDate <- '2000-01-01'#from 2000 to present date
endDate <- '2023-12-31'
pCode <- '00060' #the code for discharge in cfs
sCode <- '00003' #the code for daily mean data
RRflow <- readNWISdv(params$rseg.gauge, pCode, startDate, endDate, sCode) 

#rename the columns for table
colnames(RRflow) <- c('Agency', 'Site No', 'Date', 'Flow', 'Code')

#previewing the flow data for pre and post-dam
head(RRflow)
RRflow
```
# Data Analysis

## Subset Data 
```{r}
#subset data into years and then into seasons/months for analysis
#Winter(Dec-March) & Spring(April-Present)
  
RRflow$Date <- as.Date(RRflow$Date, format= "%m/%d/%Y")
RRflow$month <- month(RRflow$Date)
RRflow$year <- year(RRflow$Date)

Springmon= c(4,5,6)
RRspring <- RRflow %>%
  mutate(month=RRflow$month, year=RRflow$year) %>%
  group_by(year, month) %>%
  summarize(SmonthMean= mean(Flow)) %>% #same as summarize(group_by(RRflow, year, month), mean(Flow))
  filter(month == Springmon)
RRspring

Wintermon= c(1,2,3,12)
RRwinter <- RRflow %>%
  mutate(month=RRflow$month, year=RRflow$year) %>%
  group_by(year, month) %>%
  summarize(WmonthMean= mean(Flow)) %>%
  filter(month==Wintermon)
RRwinter
```

#Getting monthly average flows for the time period
```{r}
monthlyFlow = aggregate(RRflow$Flow, list(RRflow$month, RRflow$year), FUN = 'mean')
colnames(monthlyFlow) <- c('month','year','flow')
```

#Getting winters and springs:
```{r}
springFlows <- monthlyFlow %>% filter(month==4|month==5|month==6)
winterFlows <- monthlyFlow %>% filter(month==12|month==1|month==2|month==3)
```

#Quick stats:
```{r}
#Long-term averages for winter and spring seasons
winterAvg <- mean(winterFlows$flow)
springAvg <- mean(springFlows$flow)

#Seasonal averages per year
winterYrAvg <- aggregate(winterFlows$flow, by = list(winterFlows$year), FUN = 'mean')
colnames(winterYrAvg) <- c('year','flow')
springYrAvg <- aggregate(springFlows$flow, by = list(springFlows$year), FUN = 'mean')
colnames(springYrAvg) <- c('year','flow')

ggplot(winterYrAvg, aes(x=year, y=flow)) + geom_point(aes(col = 'blue')) + geom_point(data = springYrAvg, aes(x=year, y=flow, col = 'red')) +
  scale_color_identity(name = NULL, breaks=c('red','blue'), labels = c('Spring','Winter'), guide = 'legend') + 
  scale_x_continuous(breaks = seq(min(winterYrAvg$year), max(winterYrAvg$year), by = 2)) + 
  labs(x='Year', y= 'Seasonal Avg Flow (cfs)') +
  ggtitle("Winter and Spring Avg Flows (2000 - Present)")
```


##Visualization 
```{r}
#highlight winters/springs that are above/below long-term winter mean and spring mean
#how spring and winter average flows change over 2000 to now 

#Plot of all years with month avg vs time for spring
#year <- as.factor(year)
ggplot(RRspring, aes(x=month, y=SmonthMean, color=as.factor(year))) + geom_point(size=2) + xlab("Spring Months")+ ylab("Spring Month Flow Mean")+theme_minimal()+scale_x_continuous(breaks=seq(4,6,by=1)) + guides(color= guide_legend(title = "Years"))+geom_line()
```

```{r}

#Plot of all years with month avg vs time for winter
#year <- as.factor(year)
ggplot(RRwinter, aes(x=month, y=WmonthMean, color=as.factor(year))) + geom_point(size=2) + xlab("Winter Months")+ ylab("Winter Month Flow Mean")+theme_minimal() + guides(color= guide_legend(title = "Years")) + scale_x_continuous(breaks=seq(1,12, by=1))+geom_line()
```

# Boxplots
```{r}
par(mfrow=c(1,2)) #creates 2 windows side-by-side for the plots to be shown
boxplot(RRwinter$WmonthMean, ylab = 'Monthly magnitude (cfs)', main = 'Monthly Mean Winter')
boxplot(RRspring$SmonthMean, ylab = 'Monthly magnitude (cfs)', main = 'Monthly Mean Spring')
```

```{r, Boxplots of Mean Flow by Year & Season}
#create dataframe
colnames(RRspring) <- c('year', 'month', 'mean')
colnames(RRwinter) <- c('year', 'month', 'mean')
yr_avgs <- rbind(RRwinter, RRspring)
yr_avgs <- arrange(yr_avgs, year)

for(i in Springmon){
  yr_avgs$month <- gsub(i,'spring',yr_avgs$month)
}

for(i in c(12,1,2,3)){ #12 has to be first or '12' becomes 'winterwinter' from the 1 and 2
  yr_avgs$month <- gsub(i,'winter',yr_avgs$month)
}

#Note about plots: must say x=factor(year) to make it a discrete variable so that the fill by month works

#paired boxplot:
ggplot(yr_avgs, aes(x=factor(year),y=mean, fill=month)) + 
  geom_boxplot() + 
  xlab("Year") + ylab("Flow (cfs)") + ggtitle("Seasonal Mean Flow By Year") +
  scale_y_continuous(minor_breaks=seq(0,max(yr_avgs$mean),500)) +
  guides(fill=guide_legend(title="Season:")) +
  theme(axis.text.x=element_text(size=9,angle=90),
        axis.text.y=element_text(size=7),
        legend.text=element_text(size=8),
        legend.title=element_text(face="bold",size=8),
        legend.position="top",
        legend.key.height=unit(0.5,'cm'),
        legend.margin=margin(0,0,0,0),
        panel.grid.major.x=element_line(colour="light gray"))

#faceted by season:
ggplot(yr_avgs, aes(x=factor(year),y=mean, fill=month)) + 
  geom_boxplot() + 
  facet_wrap(~month, scales="fixed") +
  xlab("Year") + ylab("Flow (cfs)") + ggtitle("Seasonal Mean Flow By Year") +
  scale_y_continuous(minor_breaks=seq(0,max(yr_avgs$mean),500)) +
  guides(fill=guide_legend(title="Season:")) +
  theme(axis.text.x=element_text(size=7,angle=90),
        axis.text.y=element_text(size=7),
        strip.text=element_text(face="bold",size=8,
                                        margin=margin(3,0,3,0)),
        legend.position="none",
        panel.grid.major.x=element_line(colour="light gray"))

#faceted by year:
ggplot(yr_avgs, aes(x=factor(year),y=mean, fill=month)) + 
  geom_boxplot() + 
  facet_wrap(~year, ncol=6, scales="free", strip.position="right") +
  xlab("Year") + ylab("Flow (cfs)") + ggtitle("Seasonal Mean Flow By Year") +
  guides(fill=guide_legend(title="Season:")) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=6),
        strip.text.y.right=element_text(face="bold",size=8,
                                        margin=margin(0,1,0,2)),
        legend.text=element_text(size=7),
        legend.title=element_text(face="bold",size=7),
        legend.key.size=unit(0.5, 'cm'),
        legend.position="top",
        legend.key.height=unit(0.4,'cm'),
        legend.margin=margin(0,0,0,0),
        panel.spacing=unit(0.1,'cm'))

```


