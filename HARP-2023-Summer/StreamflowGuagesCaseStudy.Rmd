---
title: "An Analysis of USGS Gauge Mean Streamflow for Winter and Spring from 2000 to Present"
author: "Ella Fox, Glenn Campagna and Megan Pritchard"
date: "5/15/2023"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
geometry: left=2cm, right=3cm
params:
  doc_title: "USGS Gauge Mean Stremflow Winter/Spring"
  rseg.gauge: ["01636500","01668000","02037500","03529500", "03532000", "03524000", "03527220","02066000" ] #overidden by params in render cmnd
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Starting Info 

Scope: Develop RMD workflow to characterize USGS gauge mean streamflow for Winter (Dec-March) and Spring (April-present) from 2000 to present. Create visualization to highlight winters/springs that are above/below long-term winter mean and spring mean. dataretreival package.

Context: Previous research has shown that the amount of winter recharge, that is precipitation that infiltrates into groundwater, is an indicator of the subsequent summer streamflow. Thus, low winter recharge (indicated by streamflow between Dec-March) is a warning indicator for potential summer drought conditions. While Joey/DEQ have tools at the ready for drought prediction, the casual hydrologist may wonder things like seems like the hiking trails are dry this time year, is this just me or backed up with data? or I had to mow my grass before April the year...I wonder if the early leaf-on will result in sustained evapotranspiration that reduces water storage to the point of impacting summer streamflow?

## List of gauge numbers used and why 
Locations downstream are better within larger rivers to represent large basins. Locations in drought conditions are also of interest. The locations need to be above the fall line which is between the Coastal Plain and Piedmont regions of VA, because flow downstream of the fall line is tidally influenced


01636500: Shenandoah (into Potomac) - Moderate drought  
01668000: Rappahannock (Fredericksburg) - Abnormally dry  
02037500: James (Richmond) - Abnormally dry   
03529500: Powell (Big stone gap VA)  
03532000: Powell (Arthur TN)  
03524000: Clinch (Cleveland VA)  
03527220: Clinch (Looneys gap TN)   
02066000: Roanoke (Randolph VA)  



## Retrieving data from the USGS
```{r, include=FALSE}
#calling packages needed

library(zoo)
#library(IHA)  #Package not available for this version of R
#install.packages("dataRetrieval")
library(dataRetrieval)
library(dplyr)
  #megan had dependency issues loading "dplyr" and had to do this:
  #library(devtools)
  #remove.packages("cli")
  #install.packages("cli")
  #install_version("vctrs", version = "0.5.0", repos = "http://cran.us.r-project.org")
library(ggplot2)
  #to load ggplot2, had to update dependency "rlang" by doing this:
  #remove.packages("rlang")
  #install.packages("rlang")
library(knitr)
library(tidyverse)
library(pals)
library(lubridate)
library(stats)

```

```{r}
#retrieve flow data for desired river basin gauge

siteNumber <- '01636500' #We want to make this a customization variable, rn using shenandoah into Potomac to test 

startDate <- '2000-01-01'#from 2000 to present date
endDate <- '2023-12-31'
pCode <- '00060' #the code for discharge in cfs
sCode <- '00003' #the code for daily mean data
RRflow <- readNWISdv(params$rseg.gauge, pCode, startDate, endDate, sCode) #for passing in customizable var from render command

#rename the columns for table
colnames(RRflow) <- c('Agency', 'Site No', 'Date', 'Flow', 'Code')

#previewing the flow data for pre and post-dam
head(RRflow)
RRflow

```
# Data Analysis


## Subset Data 
```{r}
#subset data into years and then into seasons/months for analysis
#Winter(Dec-March) & Spring(April-Present)
  
RRflow$Date <- as.Date(RRflow$Date, format= "%m/%d/%Y")
RRflow$month <- month(RRflow$Date)
RRflow$year <- year(RRflow$Date)

Springmon= c(4,5,6)
RRspring <- RRflow %>%
  mutate(month=RRflow$month, year=RRflow$year) %>%
  group_by(year, month) %>%
  summarize(SmonthMean= mean(Flow)) %>%
  filter(month == Springmon)
RRspring

Wintermon= c(1,2,3,12)
RRwinter <- RRflow %>%
  mutate(month=RRflow$month, year=RRflow$year) %>%
  group_by(year, month) %>%
  summarize(WmonthMean= mean(Flow)) %>%
  filter(month==Wintermon)
RRwinter
```

#Long-term average Spring & Winter Flows:

```{r}
#Long-term averages for winter and spring seasons
winterAvg <- mean(RRwinter$WmonthMean)
springAvg <- mean(RRspring$SmonthMean)

paste0('Winter Average Flow: ',round(winterAvg, digits = 2), ' cfs')
paste0('Spring Average Flow: ',round(springAvg, digits = 2), ' cfs')
```

#How does this year compare to those long-term averages?

```{r}
#Comparing this year's flow with those averages
spring23 <- RRspring %>% filter(year==2023) # finding avg for this years flow
winter23 <- RRwinter %>% filter(year==2023)
spring23avg <- mean(spring23$SmonthMean)
winter23avg <- mean(winter23$WmonthMean)
#Finding percentage difference 
springPct <- ((spring23avg - springAvg)/springAvg)*100
winterPct <- ((winter23avg - winterAvg)/winterAvg)*100
paste0('Winter Flow Difference: ',round(springPct, digits = 1), '%')
paste0('Spring Flow Difference: ',round(winterPct, digits = 1), '%')
```

##Visualization 

```{r}
#Seasonal averages per year
winterYrAvg <- aggregate(winterFlows$flow, by = list(winterFlows$year), FUN = 'mean')
colnames(winterYrAvg) <- c('year','flow')
springYrAvg <- aggregate(springFlows$flow, by = list(springFlows$year), FUN = 'mean')
colnames(springYrAvg) <- c('year','flow')

ggplot(winterYrAvg, aes(x=year, y=flow)) + geom_point(aes(col = 'blue')) + geom_point(data = springYrAvg, aes(x=year, y=flow, col = 'red')) +
  scale_color_identity(name = NULL, breaks=c('red','blue'), labels = c('Spring','Winter'), guide = 'legend') + 
  scale_x_continuous(breaks = seq(min(winterYrAvg$year), max(winterYrAvg$year), by = 2)) + 
  labs(x='Year', y= 'Seasonal Avg Flow (cfs)') +
  ggtitle("Winter and Spring Avg Flows (2000 - Present)")
```


```{r}
#highlight winters/springs that are above/below long-term winter mean and spring mean
#how spring and winter average flows change over 2000 to now 

#Plot of all years with month avg vs time for spring
#year <- as.factor(year)
ggplot(RRspring, aes(x=month, y=SmonthMean, color=as.factor(year))) + geom_point(size=2) + xlab("Spring Months")+ ylab("Spring Month Flow Mean")+theme_minimal()+scale_x_continuous(breaks=seq(4,6,by=1)) + guides(color= guide_legend(title = "Years"))+geom_line()
```
```{r}

#Plot of all years with month avg vs time for winter
#year <- as.factor(year)
ggplot(RRwinter, aes(x=month, y=WmonthMean, color=as.factor(year))) + geom_point(size=2) + xlab("Winter Months")+ ylab("Winter Month Flow Mean")+theme_minimal() + guides(color= guide_legend(title = "Years")) + scale_x_continuous(breaks=seq(1,12, by=1))+geom_line()
```

# Boxplots
```{r}
par(mfrow=c(1,2)) #creates 2 windows side-by-side for the plots to be shown
boxplot(RRwinter$WmonthMean, ylab = 'Monthly magnitude (cfs)', main = 'Monthly Mean Winter')
boxplot(RRspring$SmonthMean, ylab = 'Monthly magnitude (cfs)', main = 'Monthly Mean Spring')
```

