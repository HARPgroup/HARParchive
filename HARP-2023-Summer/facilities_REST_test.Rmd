---
title: "facilities_REST_test"
author: "Analysts"
date: "`r Sys.Date()`"
output: html_document
params:
  # county or region codes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hydrotools)
basepath='/var/www/R'
source('/var/www/R/config.R')
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
```

```{r Pulling all Regions/Counties}
all_counties <- RomFeature$new(ds,list(bundle='usafips'),TRUE)
counties.df <- cbind(all_counties[["name"]], all_counties[["hydrocode"]])
  colnames(counties.df) <- c("County", "hydrocode_fips")

all_regions <- RomFeature$new(ds,list(ftype= 'wsp_plan_region'),TRUE)
regions.df <- cbind(all_regions[["name"]], all_regions[["hydrocode"]])
  colnames(regions.df) <- c("Region", "hydrocode")
```

```{r, TESTING}
#pick Amelia county codes
county_name <- counties.df[88,1]
county_hydrocode <- counties.df[88,2]
county_hydroid <- all_counties[["hydroid"]][88]

region_name <- regions.df[19,1]
region_hydrocode <- regions.df[19,2]
region_hydroid <- all_regions[["hydroid"]][19]
```

```{r Specific County/Region}
#pull specific region feature----
region <- RomFeature$new(ds, list(
      ftype= 'wsp_plan_region',
      hydrocode= region_hydrocode,
      bundle= 'landunit'), 
  TRUE)

#pull specific county feature----
county <- RomFeature$new(ds, list(
  ftype= 'county',
  hydrocode= county_hydrocode,
  bundle= 'usafips'), 
  TRUE)
```

```{r Megan--Pull by Facility}
token <- rest_token(base_url = site,rest_pw = rest_pw)
facilities <- getAdminregFeature(inputs = list(
  bundle = 'registration'),
  base_url = site)

facil_rsegs <- getAdminregFeature(inputs = list(
  bundle = 'registration',
  ftype= 'wsp_plan_watershed'),
  base_url = site)

#Maury River from AdminregFeature's admincodes----
rseg<- RomFeature$new(ds,list(
    hydrocode= facil_rsegs[1,4], 
    ftype='vahydro',
    bundle='watershed'), 
    TRUE)
 model <- RomProperty$new(ds,list(
    varkey="om_water_model_node",
    featureid=rseg$hydroid,
    entity_type="dh_feature", 
    propcode="vahydro-1.0"), 
  TRUE)
 channel_prop <- RomProperty$new(ds,list(
    featureid=model$pid,
    entity_type='dh_properties',
    propname = '0. River Channel'),
  TRUE)
 drainage_area <- RomProperty$new(channel_prop[["datasource"]],list(
    varkey="om_class_Constant",
    featureid=channel_prop$pid,
    entity_type='dh_properties',
    propname='drainage_area'),
  TRUE)
  da <- drainage_area$propvalue

  
#Pull Facility Properties----
facility <- getAdminregFeature(inputs = list(
  bundle = 'registration',
  ftype= 'vdeq_vwuds',
  admincode= 'vwuds_10333'),
  base_url = site)
  

```