---
title: "Facilities REST Testing"
author: "Analysts Megan Pritchard, Glenn Campagna, Ella Fox"
date: "`r Sys.Date()`"
output:
  word_document: default
params: null
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(hydrotools)
basepath='/var/www/R'
source('/var/www/R/config.R')
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
site <- 'http://deq1.bse.vt.edu/d.dh'
```

# Pulling All Regions/Counties
```{r Pulling all Regions/Counties, warning=FALSE, echo=TRUE, message=FALSE}
all_counties <- RomFeature$new(ds,list(bundle='usafips'),TRUE)
counties.df <- cbind(all_counties[["name"]], all_counties[["hydrocode"]])
  colnames(counties.df) <- c("County", "hydrocode_fips")

all_regions <- RomFeature$new(ds,list(ftype= 'wsp_plan_region'),TRUE)
regions.df <- cbind(all_regions[["name"]], all_regions[["hydrocode"]])
  colnames(regions.df) <- c("Region", "hydrocode")
```
## Previews:
```{r, echo=FALSE}
library(knitr)
kable(counties.df[1:8,])
kable(regions.df[1:9,])
```

\newpage
# Pulling Coverages Using Adminreg/Adminid
*note: data frames cap at 100 obs.*
```{r Testing fetch w/ admin info, warning=FALSE, echo=TRUE, message=FALSE}
token <- rest_token(base_url = site,
                    rest_uname = rest_uname,
                    rest_pw = rest_pw)

#Pulls all water supply basins, can specify one with adminid in list
wsp_basin <- getAdminregFeature(inputs = list(
  ftype = 'wsp_plan_watershed',
  bundle = 'registration'), base_url = site)

#Pulls all localities, can specify one with adminid in list
localities <- getAdminregFeature(inputs = list(
  ftype = 'wsp_plan_locality',
  bundle = 'registration'), base_url = site)

#Pulls all facilities, can specify one with adminid in list
facilities <- getAdminregFeature(inputs = list(
  ftype = 'vdeq_vwuds',
  bundle = 'registration'), base_url = site)

#Specific Localities/Facilities:
bburgLocalGov <- getAdminregFeature(inputs = list(
  adminid = '172746',
  bundle = 'local_government'), base_url = site)

bburgGolfCourse <- getAdminregFeature(inputs = list(
  adminid = '68732',
  bundle = 'registration'), base_url = site)
```
\newpage
## Previews:
```{r, echo=FALSE}
kable(wsp_basin[1:7,1:6], format="pipe",padding=0, caption="Water Supply Basins")
kable(localities[1:6,1:6], format="pipe",padding=0, caption="Localities")
kable(facilities[1:7,1:6], format="pipe", caption="Facilities")
kable(bburgLocalGov[,1:6], format="simple", caption="Blacksburg Local Government")
kable(bburgGolfCourse[,1:6], format="simple", caption="Blacksburg Golf Course")
```

\newpage
# Pull Facilities & Their Hydrocodes
```{r Facilities & Their Hydrocodes, warning=FALSE, echo=TRUE, message=FALSE}
#note: if you don't say warning=FALSE these take a LONG time to run
municipal_facilities <- RomFeature$new(ds,list(
    ftype= "municipal",
    #fstatus= "active", #or proposed, inactive, etc.
    bundle= "facility"), 
  TRUE)
municipal_facil.df <- cbind(municipal_facilities[["name"]], 
                            municipal_facilities[["hydrocode"]])
  colnames(municipal_facil.df) <- c("Municipal Facility", "hydrocode")

commercial_facilities <- RomFeature$new(ds,list(
    ftype= "commercial",
    bundle= "facility"), 
  TRUE)
commercial_facil.df <- cbind(commercial_facilities[["name"]], 
                             commercial_facilities[["hydrocode"]])
  colnames(commercial_facil.df) <- c("Commercial Facility", "hydrocode")
  
irrigation_facilities <- RomFeature$new(ds,list(
    ftype= "irrigation",
    bundle= "facility"), 
  TRUE)
irrigation_facil.df <- cbind(irrigation_facilities[["name"]], 
                             irrigation_facilities[["hydrocode"]])
  colnames(irrigation_facil.df) <- c("Irrigation Facility", "hydrocode")
  
wwtp_facilities <- RomFeature$new(ds,list(
    ftype= "wwtp",
    bundle= "facility"), 
  TRUE)
wwtp_facil.df <- cbind(wwtp_facilities[["name"]], 
                       wwtp_facilities[["hydrocode"]])
  colnames(wwtp_facil.df) <- c("WWTP Facility", "hydrocode")
  
```
\newpage
## Previews:
```{r, echo=FALSE}
kable(municipal_facil.df[1:7,])
kable(commercial_facil.df[1:6,])
kable(irrigation_facil.df[1:6,])
kable(wwtp_facil.df[1:7,])
```

\newpage
# Pulling Values from a Specific Facility
```{r Pulling Values from a Specific Facility, warning=FALSE, echo=TRUE, message=FALSE}
facility <- RomFeature$new(ds,list(
    hydrocode= "vwuds_1388", #Powhatan Courthouse Service Area
    #ftype= "municipal",
    bundle= "facility"), 
  TRUE)

val <- RomProperty$new(ds,list(
    featureid= facility$hydroid,
    propname= "wsp2020_2020_mgy"), 
  TRUE)
current_mgy <- val$propvalue

val <- RomProperty$new(ds,list(
    featureid= facility$hydroid,
    propname= "wsp2020_2040_mgy"), 
  TRUE)
future_mgy <- val$propvalue

val <- RomProperty$new(ds,list(
    featureid= facility$hydroid,
    propname= "consumption"), 
  TRUE)
consumptive_loss_frac <- val$propvalue

```
## Powhatan Courthouse Service Area:
```{r, echo=FALSE}
stats <- cbind(c("Current (MGY)","Future (MGY)", "Consumptive Loss Fraction"),c(current_mgy,future_mgy,consumptive_loss_frac))
  colnames(stats) <- c("Facility Statistic", "Value")
kable(stats)
```