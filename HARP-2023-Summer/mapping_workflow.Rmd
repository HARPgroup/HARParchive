---
title: "Workflow for Mapping Facilities"
author: "HARP Analysts"
date: "`r Sys.Date()`"
output: html_document
params:
  rivseg: ["JA4_7280_7340"] #["JA4_7280_7340"]
  model_version: ["vahydro-1.0"]
  runid_list: [ "runid_11","runid_13" ]
  metric: ["wd_mgd"]
  map_name: ["Appomatox_wd_mgd"]
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(hydrotools)
library(sp)
library(rgeos)
library(sf)
library(nhdplusTools)
library(ggmap)
library(ggplot2)
library(ggnewscale)   
library(ggsn)
library(ggspatial)
library(ggrepel)
library(nhdplusTools)

basepath='/var/www/R'
source('/var/www/R/config.R')
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
site <- 'http://deq1.bse.vt.edu/d.dh'
```

```{r UserInputs, echo=FALSE}
rivseg <- params$rivseg
model_version <- params$model_version
runid_list <- params$runid_list
metric <- params$metric
map_name <- params$map_name
```

```{r Establish Functions, echo=FALSE}
# Convert any data frame w/ geometry stored as "character" to "SpatialXxxDataFrame" (Xx_sp)
process_geom <- function(features) {
  for (i in 1:nrow(features)) {
    sp.i <- sp::addAttrToGeom(
      x=readWKT(features[i,]$dh_geofield), 
      y=as.data.frame(as.list(subset(features[i,],select=-c(dh_geofield)))),
      match.ID=TRUE
    )
    if (i == 1) {
      # start with one 
      features_sp <- sp.i
    } else {
      # append
      features_sp <- rbind(features_sp, sp.i)
    }
  }
  return(features_sp)
}
```

```{r Aquire sp Data, echo=FALSE, warning=FALSE, message=FALSE}
# Get all vahydro watershed features
allsegs <- ds$get('dh_feature', config=list(ftype='vahydro',bundle='watershed'))
allsegs$riverseg <- str_replace(allsegs$hydrocode, 'vahydrosw_wshed_', '')
# Then, extract the basin using fn_extract_basin()
basin_featr <- fn_extract_basin(allsegs, rivseg)
# Convert to sp
basin_sp <- process_geom(basin_featr)

# Get all facilities
df <- data.frame(runid=runid_list, model_version, metric=metric)
#df$runlabel <- paste('WD MGD', df$runid)
for(i in 1:length(runid_list)){
  df$runlabel[i] <- paste("metric_","runid", i, sep="")
}

facil_featr <- om_vahydro_metric_grid( 
  metric=FALSE, runids=df, featureid='all', 
  entity_type='dh_feature', bundle='facility',
  ftype='all', model_version = model_version,
  base_url = "http://deq1.bse.vt.edu/d.dh/entity-model-prop-level-export",
  ds = ds
)

# Filter down to facilities within the basin
facil_in_basin <- sqldf(
  "select a.* from facil_featr as a
   left outer join basin_featr as b
   on (a.riverseg = b.riverseg)
  where b.riverseg is not null 
  "
)
# filter out WSP entries (optional)
facil_in_basin <- sqldf("select * from facil_in_basin where hydrocode not like 'wsp_%'")

# Get facility coordinates
for(i in 1:nrow(facil_in_basin)){
  facil.i <- RomFeature$new(ds,list(hydroid=facil_in_basin$featureid[i]), TRUE)
  facil_in_basin$dh_geofield[i] <- facil.i$geom
}
# Convert to sp
facil_sp <- process_geom(facil_in_basin)

# Get County fips
fips_filename <- paste("vahydro_usafips_export.csv",sep="")
fips_destfile <- paste(tempdir(),fips_filename,sep="\\")
download.file(paste(site,"usafips_geom_export",sep="//"), destfile = fips_destfile, method = "libcurl")
fips.csv <- read.csv(file=paste(tempdir() , fips_filename,sep="\\"), header=TRUE, sep=",")
fips.csv$dh_geofield <- fips.csv$fips_geom 
fips_sp <- process_geom(fips.csv)

fips.csv$dh_geofield <- fips.csv$fips_centroid
fips_centroid_sp <- process_geom(fips.csv)
```

```{r Process Data for Plotting, echo=FALSE, warning=FALSE, message=FALSE}
#--Polygons Layer--
basin_sf <- st_as_sf(basin_sp) #Convert sp to simple features (sf)
st_crs(basin_sf) <- 4326 #Set coord. reference syst.

fips_sf <- st_as_sf(fips_sp)
st_crs(fips_sf) <- 4326

#--Points Layer--
facil_sf <- st_as_sf(facil_sp)
st_crs(facil_sf) <- 4326
facil_sf <- facil_sf[order(facil_sf$metric_runid1),]

#--Labels & Placement--
rsegs_centroids <- rgeos::gCentroid(basin_sp,byid=TRUE)
#rseg_labels <- data.frame(sf::st_coordinates(st_as_sf(rsegs_centroids)), NAME=basin_sf$riverseg)
rseg_labels <- data.frame(sf::st_coordinates(st_as_sf(rsegs_centroids)), NAME=basin_sf$name)
rseg_labels$NAME <- gsub("\\River.*", "River", rseg_labels$NAME) #remove extraneous descriptors after "River"

fips_labels <- data.frame(sf::st_coordinates(st_as_sf(fips_centroid_sp)), NAME=fips_sf$fips_name)

# gsub to shorten facility names: "[facility_name]:[river_containing_facility]" => "[facility_name]"
facil_sf$propname <- gsub("\\:.*", "", facil_sf$propname) 
facil_labels <- data.frame(sf::st_coordinates(facil_sf), NAME=facil_sf$propname)
facil_labels$NUM <- seq(1, nrow(facil_labels))
  
#--NHD Flowline Data--
sf_use_s2(FALSE) # switch off Spherical geometry (s20
domain <- st_buffer(st_as_sfc(st_bbox(basin_sf)), .2)
nhd  <- plot_nhdplus(bbox = st_bbox(domain), actually_plot = FALSE)

#Removing all 1st order streams for cleaner mapping
flowline <- as.data.frame(nhd$flowline) #extracting flowlines only from larger nhd object
flowline <- flowline[!flowline$StreamOrde == 1,] #removing all rows with a strem order of 1
flowline_sf <- st_sf(flowline) #converting to simple feature format for rejoining with nhd object
nhd$flowline <- flowline_sf

#--Facility-Metric Data--
metric_runid1 <- facil_sf$metric_runid1
metric_runid2 <- facil_sf$metric_runid2
```

```{r, eval = FALSE}
#### Custom/manual bbox creation -- FOR TESTING
bbox <- c('-81.0','36.6035','-77.1043','38.1543')
bbox_df <- matrix(nrow=2, ncol=2)
bbox_df <- as.data.frame(bbox_df)
bbox_df[,1] <- as.numeric(c(bbox[1], bbox[3]))
bbox_df[,2] <- as.numeric(c(bbox[2], bbox[4]))
bbox_sf <- st_as_sf(bbox_df, coords = c('V1','V2'), crs = 4326)
bbox_ <- st_bbox(bbox_sf)
#ggmap_bbox <- setNames(st_bbox(bbox_), c("left", "bottom", "right", "top")) # need to run this line to sub this custom bbox into rest of script
```

```{r}
# Labeling major rivers 
rivs_layer <- fread('https://github.com/HARPgroup/HARParchive/raw/master/GIS_layers/MajorRivers.csv')

riv.centroid.df <-  data.frame(feature=rivs_layer$feature, #creating data frame containing names and centroid locations 
                                GNIS_NAME=rivs_layer$GNIS_NAME,
                                centroid_longitude="",
                                centroid_latitude="",
                                stringsAsFactors=FALSE) 

for (r in 1:length(rivs_layer$feature)) { #adding coordinates to the centroids df for labeling
    riv_geom <- readWKT(rivs_layer$geom[r])
    riv_geom_centroid <- gCentroid(riv_geom,byid=TRUE)
    riv.centroid.df$centroid_longitude[r] <- riv_geom_centroid$x
    riv.centroid.df$centroid_latitude[r] <- riv_geom_centroid$y  
    # riv_geom_clip <- gIntersection(MB_geom, riv_geom)
    riv_geom_clip <- riv_geom
    
    if (is.null(riv_geom_clip) == TRUE) {
      # print("OUT OF MINOR BASIN EXTENT - SKIPPING") 
      next
    }
}
```

```{r}
# Labeling order 6 streams aka large rivers (Alternate method to using MajorRivers.csv, best method TBD)
# Names are contained within flowline data -- testing with naming by order 4 streams (Major rivers = order 6)
streams_order67 <- flowline[flowline$StreamOrde == c(6,7),]
streams67 <- streams_order67[!streams_order67$gnis_name==' ',] # Need to remove rows without names 
streams67 <- streams67[!duplicated(streams67$gnis_id),] #Only want 1 row per stream name 

stream67.centroid.df <-  data.frame(feature=(1:length(streams67$id)), #creating data frame containing names and centroid locations 
                                GNIS_NAME=streams67$gnis_name,
                                centroid_longitude="",
                                centroid_latitude="",
                                stringsAsFactors=FALSE) 

for (r in 1:length(streams67$id)) { #adding coordinates to the centroids df for labeling
    stream_geom_centroid <- st_centroid(streams67$geometry[r])
    cent.coords <- as.data.frame(st_coordinates(stream_geom_centroid))
    stream67.centroid.df$centroid_longitude[r] <- cent.coords$X
    stream67.centroid.df$centroid_latitude[r] <- cent.coords$Y
    }
```

```{r}
# Creating subset of order 6 stream flowlines for mapping thicker lines 
flowline67 <- flowline[flowline$StreamOrde == c(6,7),] #removing all rows with a strem order of 1
flowline67_sf <- st_sf(flowline67) #converting to simple feature format for rejoining with nhd object
nhd$flowline67 <- flowline67_sf
```


```{r}
# Labeling order 4 streams 
# Names are contained within flowline data -- testing with naming by order 4 streams (Major rivers = order 6)
streams_order4 <- flowline[flowline$StreamOrde == 4,]
streams4 <- streams_order4[!streams_order4$gnis_name==' ',] # Need to remove rows without names 
streams4 <- streams4[!duplicated(streams4$gnis_id),] #Only want 1 row per stream name 

stream4.centroid.df <-  data.frame(feature=(1:length(streams4$id)), #creating data frame containing names and centroid locations 
                                GNIS_NAME=streams4$gnis_name,
                                centroid_longitude="",
                                centroid_latitude="",
                                stringsAsFactors=FALSE) 

for (r in 1:length(streams4$id)) { #adding coordinates to the centroids df for labeling
    stream_geom_centroid <- st_centroid(streams4$geometry[r])
    cent.coords <- as.data.frame(st_coordinates(stream_geom_centroid))
    stream4.centroid.df$centroid_longitude[r] <- cent.coords$X
    stream4.centroid.df$centroid_latitude[r] <- cent.coords$Y
    }
```

```{r, eval=FALSE}
# Labeling major reservoirs 
#setwd(export_path)
#unzip(paste0(export_path,"MajorReservoirs.zip")) #must be downloaded to your working directory 
#reservoir_sf <- read_sf('MajorReservoirs.shp')
```

```{r Create Map Base, echo=FALSE, warning=FALSE, message=FALSE}
ggmap_bbox <- st_buffer(st_as_sfc(st_bbox(basin_sf)), .05)
ggmap_bbox <- setNames(st_bbox(ggmap_bbox), c("left", "bottom", "right", "top"))
basemap <- ggmap::get_stamenmap(maptype = "terrain", color="color", bbox = ggmap_bbox, zoom = 12)
basemap <- ggmap(basemap)
```

```{r Generate Map Object, echo=FALSE}
map <- basemap + #ggplot2::
    geom_sf(data = fips_sf, inherit.aes = FALSE, color = "#0033335F", fill = NA, lwd=1) +

    geom_sf(data = nhd$flowline,inherit.aes = FALSE,color = "#009999", fill = NA, lwd = 0.3) + # mapping all flowlines
    geom_sf(data = nhd$flowline67,inherit.aes = FALSE,color = "blue", fill = NA, lwd = 1.0) + # mapping flowlines of major rivers
    geom_sf(data = nhd$network_wtbd,inherit.aes = FALSE,color = "#009999", fill = NA, size = 1) +
    geom_sf(data = nhd$off_network_wtbd,inherit.aes = FALSE,color = "#009999", fill = NA, size = 1) +
  
    geom_sf(data = basin_sf, inherit.aes = FALSE, color = "#002289", fill = "#0022974C", lwd=1) +
    #geom_sf(data = facil_sf, inherit.aes = FALSE, color = "white", fill = "black", size = 10, pch = 21) +
    
  # 2020 MGD
    geom_point(data = facil_labels, aes(X, Y, size=metric_runid1, alpha=metric_runid1), 
               #alpha = .7, 
               col="yellow", shape = 19, stroke = 0.75) +
      scale_size(range = c(10,35), 
                 breaks = c(0, metric_runid1[metric_runid1!=0]),
                 labels = round(c(0, metric_runid1[metric_runid1!=0]), digits = 3),
                 #guide = guide_legend(title = paste(metric, runid_list[1], sep="_"))
                 name = paste(metric, runid_list[1], sep="_")
                 ) + #NOTE: the two scales need identical "name" and "labels" to become one simultaneous legend
      scale_alpha(range = c(0.5, 0.95),
                 breaks = c(0, metric_runid1[metric_runid1!=0]),
                 labels = round(c(0, metric_runid1[metric_runid1!=0]), digits = 3),
                 #guide = FALSE
                 name = paste(metric, runid_list[1], sep="_")
                 ) +
    # 2040 MGD
    #new_scale("size") + new_scale("color") + new_scale("alpha") +
    #geom_point(data = facil_labels,aes(X, Y, size=metric_runid2, alpha=metric_runid2), 
    #           #alpha = .5, 
    #           col="red", shape = 19, stroke = 0) +
    #  scale_size(range = c(15,40), 
    #             breaks = c(0, metric_runid2[metric_runid2!=0]),
    #             labels = c(0, metric_runid2[metric_runid2!=0]),
    #             guide = guide_legend(title = paste(metric, runid_list[2], sep="_"))
    #             ) +
    #   scale_alpha(range = c(0.35, 0.8),
    #             breaks = c(0, metric_runid1[metric_runid1!=0]),
    #             labels = c(0, metric_runid1[metric_runid1!=0]),
    #             guide = FALSE
    #             ) +

    theme(text = element_text(size = 30),axis.title.x=element_blank(),axis.title.y=element_blank()) +
    
    # plot labels
    geom_label(data = rseg_labels, aes(X, Y, label = NAME), colour = "#002269", fill=NA, size=7,
               label.size=0, label.r= unit(0.3, "mm")) +
    geom_label(data = fips_labels, aes(X, Y, label = NAME), colour = "#003333", fill= NA, size=9, 
               label.size=0, label.r= unit(0.3, "mm")) +
    geom_text(data = facil_labels, aes(X, Y, label = NUM), colour = "black", size = 7) +
  #  geom_label(data = facil_labels, aes(X, Y, label = NUM), colour = "black", size = 10, 
     #          nudge_x = -0.01, nudge_y = 0.01) +
    geom_text(data = riv.centroid.df, aes(x = as.numeric(centroid_longitude), y = as.numeric(centroid_latitude), group = 1, label = GNIS_NAME),size = 10, 
                    color = "dodgerblue3") + #labeling major rivers
    geom_text_repel(data = stream67.centroid.df, aes(x = as.numeric(centroid_longitude), y = as.numeric(centroid_latitude), group = 1, label = GNIS_NAME),
                    size = 10, color = "red") + #labeling order 6 & 7 streams -- also major rivers
    geom_text(data = stream4.centroid.df, aes(x = as.numeric(centroid_longitude), y = as.numeric(centroid_latitude), group = 1, label = GNIS_NAME),size = 6, 
                    color = "dodgerblue3") + #labeling order 4 streams
    # scalebar
    ggsn::scalebar(basin_sf, location = 'bottomleft', dist = 2, dist_unit = 'mi',
                   transform = TRUE, model = 'WGS84',st.bottom=FALSE, st.size=12 ) +
    # north arrow
    ggspatial::annotation_north_arrow(which_north = "grid", location = "tr",
                                      height = unit(4, "cm"),width = unit(3, "cm"), 
                                      style = north_arrow_orienteering(text_size = 35)
                                      )
```

```{r Save Map.png, echo=FALSE}
library(flextable)
table <- qflextable(facil_labels[,c("NUM", "NAME")])

ggsave(
  filename = paste(export_path, map_name,".png",sep=""),
  plot = map,
  width = 25,
  height = 20
  )
```

```{r Joey's Scale Bar, eval=FALSE, echo=FALSE}
base_scale <-  ggsn::scalebar(data = bbDF, location = 'bottomleft', dist = 25, dist_unit = 'mi', 
                                transform = TRUE, model = 'WGS84',st.bottom=FALSE, 
                                st.size = 3, st.dist = 0.03,
                                anchor = c(
                                  x = (((extent$x[2] - extent$x[1])/2)+extent$x[1])-0.45,
                                  y = extent$y[1]+(extent$y[1])*0.001
                                ))
```

